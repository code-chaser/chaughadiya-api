<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Chaughadiya</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <style>
        @property --gradient-angle {
            syntax: '<angle>';
            initial-value: 0deg;
            inherits: false;
        }

        :root {
            --primary-color: #FF9933; /* Saffron */
            --secondary-color: #800000; /* Maroon */
            --accent-color: #138808; /* Green */
            --light-bg: #FDF5E6; /* Papaya Whip */
            --dark-bg: #1a1d29; /* Dark Blue Grey */
            --card-bg-light: #ffffff;
            --card-bg-dark: #2c3e50;
            --light-text: #333;
            --dark-text: #ECF0F1; /* Silver */
            --border-light: #e0e0e0;
            --border-dark: #444;
            --shadow-light: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-dark: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        [data-bs-theme="light"] {
            --bs-body-bg: var(--light-bg);
            --bs-body-color: var(--light-text);
            --bs-border-color: var(--border-light);
        }

        [data-bs-theme="dark"] {
            --bs-body-bg: var(--dark-bg);
            --bs-body-color: var(--dark-text);
            --bs-border-color: var(--border-dark);
        }

        body {
            background: linear-gradient(135deg, var(--bs-body-bg) 0%, rgba(255, 153, 51, 0.1) 100%);
            min-height: 100vh;
        }

        .navbar {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #a04000 100%) !important;
            box-shadow: var(--shadow-light);
            position: sticky;
            top: 0;
            z-index: 1030;
        }

        .navbar::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-color);
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: var(--shadow-light);
            backdrop-filter: blur(10px);
            background: var(--card-bg-light);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        [data-bs-theme="dark"] .card {
            background: var(--card-bg-dark);
            box-shadow: var(--shadow-dark);
        }

        .card:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .card-header {
            border-top-left-radius: 15px !important;
            border-top-right-radius: 15px !important;
        }

        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid var(--border-light);
            transition: all 0.3s ease;
        }

        [data-bs-theme="dark"] .form-control, 
        [data-bs-theme="dark"] .form-select {
            border-color: var(--border-dark);
            background-color: #34495e;
            color: var(--dark-text);
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(255, 153, 51, 0.25);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, #E68A2E 100%);
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 153, 51, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #E68A2E 0%, var(--primary-color) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 153, 51, 0.4);
        }

        #map {
            border-radius: 15px;
            box-shadow: var(--shadow-light);
            border: 3px solid var(--primary-color);
        }

        .table {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--shadow-light);
        }

        .chaughadiya-table {
            margin: 0;
            font-family: 'Courier New', monospace;
        }

        .chaughadiya-table thead {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .chaughadiya-table th {
            font-weight: 600;
            padding: 12px;
            border: none;
        }

        .chaughadiya-table td {
            padding: 10px 12px;
            vertical-align: middle;
            border-bottom: 1px solid var(--border-light);
        }

        [data-bs-theme="dark"] .chaughadiya-table td {
            border-bottom-color: var(--border-dark);
        }

        .chaughadiya-table tbody tr:last-child td {
            border-bottom: none;
        }

        .chaughadiya-table tbody tr:hover {
            background-color: rgba(255, 153, 51, 0.1);
        }

        .table-responsive {
            border-radius: 10px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .div-heading-headers {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #a04000 100%)
        }

        /* Current Muhurat Styles */
        .current-muhurat-banner {
            padding: 0.25rem;
            border-radius: 19px;
            box-shadow: 0 0.5px 20px rgba(255, 153, 51, 0.4);
            margin-bottom: 2rem;
            position: relative;
            background: conic-gradient(
                from var(--gradient-angle),
                var(--primary-color) 0deg,
                var(--secondary-color) 180deg
            );
            animation: rotateGradient 7s linear infinite;
        }

        @keyframes rotateGradient {
            from { --gradient-angle: 0deg; }
            to { --gradient-angle: 360deg; }
        }

        @keyframes stripes {
            0% { background-position: 0 0; }
            100% { background-position: 50px 50px; }
        }

        .current-muhurat-content {
            position: relative;
            z-index: 1;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 15px;
            padding: 1.5rem;
            color: white;
        }

        .countdown-timer {
            font-family: 'Courier New', monospace;
            font-size: 2rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .live-clock {
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .current-muhurat-highlight {
            background-color: rgba(255, 153, 51, 0.2) !important;
            border: 3px solid var(--primary-color) !important;
            position: relative;
        }

        .current-muhurat-highlight::after {
            content: 'CURRENT';
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 5px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .progress-bar-muhurat {
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 1rem;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #fff, rgba(255,255,255,0.6));
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        /* Footer Styles */
        .creative-footer {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #a04000 100%);
            color: white;
            padding: 3rem 0 2rem;
            margin-top: 4rem;
            position: relative;
            overflow: hidden;
        }

        .creative-footer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-color);
        }

        @keyframes shimmer {
            0%, 100% { background-position: 0% 0%; }
            50% { background-position: 100% 0%; }
        }

        .creative-footer::after {
            content: 'üïâÔ∏è   ‚ò∏Ô∏è   ‚ú®   üôè   ‚ú®   üôè   ‚ú®   ‚ò∏Ô∏è   üïâÔ∏è';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            opacity: 0.05;
            white-space: nowrap;
            letter-spacing: 4rem;
            pointer-events: none;
            padding-left: 4rem;
        }

        [data-bs-theme="dark"] .creative-footer::after {
            opacity: 0.07;
        }

        .footer-content {
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .footer-divider {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
            gap: 1rem;
        }

        .footer-divider-line {
            height: 2px;
            width: 80px;
            background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
        }

        .footer-divider-icon {
            font-size: 1.5rem;
            color: var(--primary-color);
            animation: glow 5s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% {
                text-shadow: 0 0 10px rgba(255, 153, 51, 0.5),
                            0 0 20px rgba(255, 153, 51, 0.3);
            }
            50% {
                text-shadow: 0 0 20px rgba(255, 153, 51, 0.8),
                            0 0 30px rgba(255, 153, 51, 0.5);
            }
        }

        .footer-text {
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            flex-wrap: wrap;
        }

        .footer-link-container {
            display: inline-block;
            perspective: 1000px;
            cursor: pointer;
        }

        .footer-link {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.3rem 0.8rem;
            border-radius: 8px;
            background: rgba(255, 153, 51, 0.1);
            color: var(--primary-color);
            font-weight: 700;
            font-size: 1.1rem;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }

        .footer-link.flipped {
            transform: rotateX(180deg);
        }

        .footer-link-front,
        .footer-link-back {
            backface-visibility: hidden;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .footer-link-back {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            align-items: center;
            font-size: 0.79rem;
            /*align vertically middle*/
            height: 100%;
            padding: auto;
            justify-content: center;
            transform: rotateX(180deg);
        }

        .footer-icon {
            animation: bounce 2s ease-in-out infinite;
        }

        .footer-heart {
            font-size: 1.4rem;
            color: #ff6b6b;
            animation: heartbeat 1.9s linear infinite;
            display: inline-block;
            filter: drop-shadow(0 0 5px rgba(255, 107, 107, 0.5));
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            10%, 30% { transform: scale(1.2); }
            20%, 40% { transform: scale(1); }
        }

        .footer-subtext {
            font-size: 1rem;
            opacity: 0.95;
            margin-top: 1rem;
            font-style: italic;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        @keyframes pulse-om {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.15);
                opacity: 0.8;
            }
        }

        .footer-quote {
            max-width: 600px;
            margin: 1.5rem auto 0;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border-left: 4px solid var(--primary-color);
            border-right: 4px solid var(--primary-color);
            font-size: 0.9rem;
            font-style: italic;
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .footer-text {
                font-size: 1rem;
            }
            
            .footer-link {
                font-size: 1.1rem;
            }
            
            .footer-subtext {
                font-size: 0.9rem;
            }
            
            .footer-divider-line {
                width: 50px;
            }
            
            .footer-quote {
                font-size: 0.85rem;
                padding: 0.8rem;
            }
        }

        /* Mobile Responsiveness */
        @media (max-width: 992px) {
            .navbar .d-flex {
                flex-wrap: wrap;
                gap: 0.5rem !important;
            }
            
            .form-check {
                margin: 0.25rem 0;
            }
        }

        @media (max-width: 768px) {
            body {
                font-size: 0.95rem;
            }

            #map {
                height: 250px !important;
            }
            
            .navbar .container-fluid {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .navbar-brand {
                font-size: 1.3rem;
                margin: 0 auto;
            }

            .navbar .d-flex {
                width: 100%;
                justify-content: center !important;
            }

            .form-check-label {
                font-size: 0.8rem;
            }

            .btn-sm {
                font-size: 0.75rem;
                padding: 0.25rem 0.5rem;
            }
            
            .chaughadiya-table {
                font-size: 0.8rem;
            }
            
            .chaughadiya-table th,
            .chaughadiya-table td {
                padding: 6px 4px;
                white-space: nowrap;
            }

            .chaughadiya-table th:first-child,
            .chaughadiya-table td:first-child {
                padding-left: 8px;
            }

            .chaughadiya-table th:last-child,
            .chaughadiya-table td:last-child {
                padding-right: 8px;
            }
            
            .form-floating > label {
                font-size: 0.85rem;
            }
            
            .card-body {
                padding: 0.75rem;
            }

            .card-header h5 {
                font-size: 1rem;
            }
            
            .btn-primary {
                padding: 10px 15px;
                font-size: 0.9rem;
            }

            /* Current Muhurat Banner - Mobile */
            .current-muhurat-banner {
                padding: 0.25rem;  /* Match your desktop border thickness */
            }

            .current-muhurat-banner .fa-4x {
                font-size: 2.5rem;
            }

            .current-muhurat-banner h4 {
                font-size: 1rem;
            }

            .current-muhurat-banner h2 {
                font-size: 1.5rem;
            }

            .countdown-timer {
                font-size: 1.3rem;
            }

            .live-clock {
                font-size: 0.95rem;
            }

            /* Time info cards */
            .time-info i {
                font-size: 2rem !important;
            }

            .time-info h5 {
                font-size: 0.95rem;
            }

            .time-info h3 {
                font-size: 1.5rem;
            }

            .time-info h6 {
                font-size: 0.85rem;
            }

            /* Muhurat timeline cards - better mobile layout */
            .col-lg-3.col-md-4.col-sm-6 {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
                flex: 0 0 50%;
                max-width: 50%;
            }

            .card .fa-2x {
                font-size: 1.5rem;
            }

            .card-title {
                font-size: 0.9rem;
            }

            .badge {
                font-size: 0.75rem;
                padding: 4px 8px;
            }

            .card-text {
                font-size: 0.85rem;
            }

            /* Muhurat meanings */
            .muhurat-meanings .fa-lg {
                font-size: 1.2rem !important;
            }

            /* Modals on mobile */
            .modal-body {
                padding: 1rem;
            }

            .modal-title {
                font-size: 1.1rem;
            }
        }

        @media (max-width: 576px) {
            body {
                font-size: 0.9rem;
            }

            .container {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }

            .main-container {
                padding: 0.75rem;
                margin-top: 1rem;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .lead {
                font-size: 0.9rem;
            }

            .navbar-brand {
                font-size: 1.1rem;
            }

            #map {
                height: 200px !important;
            }

            .form-check-label {
                font-size: 0.7rem;
            }

            .btn-sm {
                font-size: 0.7rem;
                padding: 0.2rem 0.4rem;
            }

            .btn-sm i {
                font-size: 0.8rem;
            }

            .card {
                border-radius: 10px;
                margin-bottom: 0.75rem;
            }

            .card-body {
                padding: 0.5rem;
            }

            .card-header {
                padding: 0.5rem 0.75rem;
            }

            .card-header h5 {
                font-size: 0.9rem;
            }

            /* Current Muhurat Banner - Small mobile */
            .current-muhurat-banner {
                padding: 0.25rem;  /* Match your desktop border thickness */
                margin-bottom: 1rem;
            }

            .current-muhurat-banner .fa-4x {
                font-size: 2rem;
            }

            .current-muhurat-banner h4 {
                font-size: 0.85rem;
                margin-bottom: 0.25rem;
            }

            .current-muhurat-banner h2 {
                font-size: 1.25rem;
                margin-bottom: 0.25rem;
            }

            .current-muhurat-banner p {
                font-size: 0.8rem;
                margin-bottom: 0.5rem;
            }

            .countdown-timer {
                font-size: 1.1rem;
            }

            .live-clock {
                font-size: 0.85rem;
            }

            /* Time info cards - Small mobile */
            .time-info {
                padding: 0.5rem;
            }

            .time-info i {
                font-size: 1.5rem !important;
            }

            .time-info h5 {
                font-size: 0.85rem;
                margin-bottom: 0.25rem;
            }

            .time-info h3 {
                font-size: 1.25rem;
            }

            .time-info h6 {
                font-size: 0.75rem;
            }

            /* Table responsiveness */
            .chaughadiya-table {
                font-size: 0.7rem;
            }

            .chaughadiya-table th,
            .chaughadiya-table td {
                padding: 4px 2px;
            }

            .chaughadiya-table th:first-child,
            .chaughadiya-table td:first-child {
                padding-left: 4px;
            }

            .chaughadiya-table th:last-child,
            .chaughadiya-table td:last-child {
                padding-right: 4px;
            }

            .chaughadiya-table i {
                display: none; /* Hide icons in table on very small screens */
            }

            /* Timeline cards - Small mobile - single column */
            .col-lg-3.col-md-4.col-sm-6 {
                padding-left: 0.25rem;
                padding-right: 0.25rem;
                margin-bottom: 0.5rem;
                flex: 0 0 100%;
                max-width: 100%;
            }

            .card .card-body {
                padding: 0.75rem;
                display: flex;
                flex-direction: column;
            }

            .card .fa-2x {
                font-size: 1.5rem;
            }

            .card-title {
                font-size: 0.9rem;
                margin-bottom: 0.5rem;
            }

            .card-text {
                font-size: 0.8rem;
                margin-bottom: 0.5rem;
            }

            .badge {
                font-size: 0.7rem;
                padding: 4px 8px;
            }

            /* Muhurat meanings - Small mobile */
            .muhurat-meanings .col-lg-4 {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }

            .muhurat-meanings .fa-lg {
                font-size: 1rem !important;
                margin-right: 0.5rem !important;
            }

            .muhurat-meanings strong {
                font-size: 0.85rem;
            }

            .muhurat-meanings small {
                font-size: 0.7rem;
            }

            /* Form elements */
            .form-floating > .form-control,
            .form-floating > .form-select {
                height: calc(3rem + 2px);
                font-size: 0.85rem;
            }

            .form-floating > label {
                font-size: 0.75rem;
                padding: 0.75rem 0.5rem;
            }

            .btn-primary {
                padding: 8px 12px;
                font-size: 0.85rem;
            }

            /* Alert messages */
            .alert {
                font-size: 0.85rem;
                padding: 0.5rem 0.75rem;
            }

            /* Modal adjustments */
            .modal-dialog {
                margin: 0.5rem;
            }

            .modal-header,
            .modal-footer {
                padding: 0.75rem;
            }

            .modal-body {
                padding: 0.75rem;
            }

            /* Date dropdowns on small screens */
            .row.g-2 {
                gap: 0.25rem !important;
            }

            /* Current muhurat highlight badge */
            .current-muhurat-highlight::after {
                font-size: 0.6rem;
                padding: 1px 4px;
                top: 2px;
                right: 2px;
            }
        }

        /* Landscape mobile phones */
        @media (max-width: 768px) and (orientation: landscape) {
            #map {
                height: 180px !important;
            }

            .current-muhurat-banner {
                padding: 0.25rem;  /* Match your desktop border thickness */
            }

            .current-muhurat-banner .row {
                align-items: center;
            }

            .current-muhurat-banner .col-md-3,
            .current-muhurat-banner .col-md-6,
            .current-muhurat-banner .col-md-3 {
                margin-bottom: 0 !important;
            }
        }

        /* Very small screens / older phones */
        @media (max-width: 375px) {
            h1 {
                font-size: 1.3rem;
            }

            .lead {
                font-size: 0.85rem;
            }

            .navbar-brand {
                font-size: 1rem;
            }

            .form-check-label {
                font-size: 0.65rem;
            }

            .countdown-timer {
                font-size: 1rem;
            }

            .time-info h3 {
                font-size: 1.1rem;
            }
        }

        .badge {
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: 600;
        }

        .section-title {
            font-weight: 700;
            color: var(--primary-color);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .main-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-light);
            margin-top: 2rem;
        }

        [data-bs-theme="dark"] .main-container {
            background: rgba(44, 62, 80, 0.3);
        }

        .list-group-item {
            border-radius: 8px;
            margin-bottom: 2px;
            border: 1px solid var(--border-light);
            transition: all 0.2s ease;
        }

        .list-group-item:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateX(5px);
        }

        [data-bs-theme="dark"] .list-group-item {
            background-color: var(--card-bg-dark);
            border-color: var(--border-dark);
            color: var(--dark-text);
        }

        .muhurat-card {
            background: linear-gradient(135deg, var(--primary-color) 0%, #E68A2E 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 6px 20px rgba(255, 153, 51, 0.3);
        }

        .time-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1rem;
            backdrop-filter: blur(5px);
        }

        /* Enhanced Sunrise/Sunset Icons */
        .sun-icon-container,
        .moon-icon-container {
            position: relative;
            display: inline-block;
            animation: iconFloat 3s ease-in-out infinite;
        }

        @keyframes iconFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .sunrise-info {
            background: linear-gradient(135deg, rgba(255, 165, 0, 0.15), rgba(255, 215, 0, 0.1));
            border: 2px solid rgba(255, 165, 0, 0.3);
            transition: all 0.3s ease;
        }

        .sunrise-info:hover {
            background: linear-gradient(135deg, rgba(255, 165, 0, 0.2), rgba(255, 215, 0, 0.15));
            border-color: rgba(255, 165, 0, 0.5);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 165, 0, 0.3);
        }

        .sunset-info {
            background: linear-gradient(135deg, rgba(255, 99, 71, 0.15), rgba(255, 69, 0, 0.1));
            border: 2px solid rgba(255, 99, 71, 0.3);
            transition: all 0.3s ease;
        }

        .sunset-info:hover {
            background: linear-gradient(135deg, rgba(255, 99, 71, 0.2), rgba(255, 69, 0, 0.15));
            border-color: rgba(255, 99, 71, 0.5);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 99, 71, 0.3);
        }

        .sunrise-info .fa-sun {
            filter: drop-shadow(0 0 10px rgba(255, 165, 0, 0.6));
        }

        .sunset-info .fa-moon {
            filter: drop-shadow(0 0 10px rgba(255, 99, 71, 0.6));
        }

        .sunrise-info:hover .sun-icon-container,
        .sunset-info:hover .moon-icon-container {
            animation: iconBounce 0.6s ease;
        }

        @keyframes iconBounce {
            0%, 100% { transform: translateY(0); }
            25% { transform: translateY(-10px); }
            50% { transform: translateY(0); }
            75% { transform: translateY(-5px); }
        }

        /* Tithi Information Styles */
        .tithi-info-card {
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.15), rgba(123, 104, 238, 0.1));
            border: 2px solid rgba(138, 43, 226, 0.3);
            border-radius: 15px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            margin-bottom: 2rem;
        }

        .tithi-info-card:hover {
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.2), rgba(123, 104, 238, 0.15));
            border-color: rgba(138, 43, 226, 0.5);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(138, 43, 226, 0.3);
        }

        .tithi-icon-container {
            position: relative;
            display: inline-block;
            animation: iconFloat 3s ease-in-out infinite;
        }

        .tithi-info-card .fa-moon {
            filter: drop-shadow(0 0 10px rgba(138, 43, 226, 0.6));
        }

        .tithi-paksha-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .shukla-paksha {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #333;
        }

        .krishna-paksha {
            background: linear-gradient(135deg, #4a5568, #2d3748);
            color: white;
        }

        .tithi-progress-bar {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            height: 10px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .tithi-progress-fill {
            background: linear-gradient(135deg, #8a2be2, #9370db);
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        [data-bs-theme="dark"] .tithi-info-card {
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.2), rgba(123, 104, 238, 0.15));
            border-color: rgba(138, 43, 226, 0.4);
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-floating > .form-control, .form-floating > .form-select {
            height: calc(3.5rem + 2px);
            line-height: 1.25;
        }

        .form-floating > label {
            padding: 1rem 0.75rem;
        }

        .gradient-text {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        /* Better touch targets for mobile */
        @media (hover: none) and (pointer: coarse) {
            .btn {
                min-height: 44px;
                min-width: 44px;
            }

            .form-check-input {
                width: 2rem;
                height: 1rem;
            }

            .form-check {
                padding-left: 2.5rem;
            }
        }

        /* Prevent zoom on input focus in iOS */
        @media screen and (max-width: 768px) {
            select,
            textarea,
            input[type="text"],
            input[type="password"],
            input[type="datetime"],
            input[type="datetime-local"],
            input[type="date"],
            input[type="month"],
            input[type="time"],
            input[type="week"],
            input[type="number"],
            input[type="email"],
            input[type="url"] {
                font-size: 16px !important;
            }
        }

        /* Improve scrolling performance */
        .table-responsive,
        .card-body {
            -webkit-overflow-scrolling: touch;
        }

        /* Hide horizontal scrollbar but keep functionality */
        .table-responsive::-webkit-scrollbar {
            height: 6px;
        }

        .table-responsive::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        .table-responsive::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }

        /* Better spacing for location suggestions on mobile */
        #location-suggestions {
            max-height: 250px;
            overflow-y: auto;
        }

        @media (max-width: 576px) {
            #location-suggestions {
                max-height: 180px;
            }

            #location-suggestions .list-group-item {
                font-size: 0.85rem;
                padding: 0.5rem 0.75rem;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand text-white" href="#">
                <i class="fas fa-sun me-2"></i>Chaughadiya
            </a>
            <div class="d-flex gap-2 gap-md-3 ms-auto align-items-center flex-wrap justify-content-end">
                <button class="btn btn-sm btn-outline-light" id="favoritesBtn" title="Favorite Locations">
                    <i class="fas fa-star"></i><span class="d-none d-sm-inline ms-1">Favorites</span>
                </button>
                <button class="btn btn-sm btn-outline-light" id="shareBtn" title="Share Results" style="display: none;">
                    <i class="fas fa-share-alt"></i><span class="d-none d-sm-inline ms-1">Share</span>
                </button>
                <div class="form-check form-switch mb-0">
                    <input class="form-check-input" type="checkbox" id="timeFormatSwitcher">
                    <label class="form-check-label text-white" for="timeFormatSwitcher">
                        <i class="fas fa-clock me-1"></i><span class="d-none d-md-inline">24-Hour</span>
                    </label>
                </div>
                <div class="form-check form-switch mb-0">
                    <input class="form-check-input" type="checkbox" id="themeSwitcher">
                    <label class="form-check-label text-white" for="themeSwitcher">
                        <i class="fas fa-moon me-1"></i><span class="d-none d-md-inline">Dark</span>
                    </label>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="main-container">
            <div class="text-center mb-4">
                <h1 class="gradient-text">Chaughadiya Calculator</h1>
                <p class="lead">Discover the auspicious and inauspicious times of the day according to Vedic astrology</p>
            </div>
            
            <!-- Input Section -->
            <div class="card mb-4">
                <div class="card-header div-heading-headers text-white">
                    <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Enter Details</h5>
                </div>
                <div class="card-body">
                    <form id="chaughadiya-form">
                        <div class="row">
                            <div class="col-lg-6 mb-3">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="location" placeholder="Enter a location">
                                    <label for="location"><i class="fas fa-map-marker-alt me-2"></i>Location</label>
                                </div>
                            </div>
                            
                            <div class="col-lg-6 mb-3">
                                <div class="row g-2">
                                    <div class="col-4">
                                        <div class="form-floating">
                                            <select class="form-select" id="day" required>
                                                <option value="">Day</option>
                                            </select>
                                            <label for="day"><i class="fas fa-calendar-day me-1"></i>Day</label>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="form-floating">
                                            <select class="form-select" id="month" required>
                                                <option value="">Month</option>
                                                <option value="1">January</option>
                                                <option value="2">February</option>
                                                <option value="3">March</option>
                                                <option value="4">April</option>
                                                <option value="5">May</option>
                                                <option value="6">June</option>
                                                <option value="7">July</option>
                                                <option value="8">August</option>
                                                <option value="9">September</option>
                                                <option value="10">October</option>
                                                <option value="11">November</option>
                                                <option value="12">December</option>
                                            </select>
                                            <label for="month"><i class="fas fa-calendar-alt me-1"></i>Month</label>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="form-floating">
                                            <select class="form-select" id="year" required>
                                                <option value="">Year</option>
                                            </select>
                                            <label for="year"><i class="fas fa-calendar me-1"></i>Year</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-lg-8 mb-3 mb-lg-0">
                                <div id="map" style="height: 300px;"></div>
                            </div>
                            
                            <div class="col-lg-4 d-flex flex-column">
                                <div class="form-floating mb-3">
                                    <select class="form-select" id="timezone">
                                        <option value="">Select timezone</option>
                                    </select>
                                    <label for="timezone"><i class="fas fa-globe me-2"></i>Timezone</label>
                                </div>
                                
                                <button type="submit" class="btn btn-primary w-100 mt-auto mb-2">
                                    <i class="fas fa-search me-2"></i>Get Chaughadiya
                                </button>
                                <button type="button" class="btn btn-outline-primary w-100" id="saveFavoriteBtn">
                                    <i class="fas fa-star me-2"></i>Save as Favorite
                                </button>
                            </div>
                        </div>
                    </form>
                        </div>
                    </div>

            <!-- Results Section -->
            <div class="card mb-4">
                <div class="card-header div-heading-headers text-white">
                    <h5 class="mb-0"><i class="fas fa-star me-2"></i>Results</h5>
                </div>
                <div class="card-body">
                    <div class="loading-spinner" id="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Calculating Chaughadiya...</p>
                    </div>
                    <div id="results-container">
                        <div class="text-center text-muted">
                            <i class="fas fa-info-circle fa-3x mb-3"></i>
                            <p>Select a date and location to view the Chaughadiya timings</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Muhurat Information (Always visible) -->
            <div class="card mt-4">
                <div class="card-header div-heading-headers text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Muhurat Meanings</h5>
                </div>
                <div class="card-body muhurat-meanings">
                    <div class="row">
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-gem fa-lg text-success me-2 me-md-3"></i>
                                <div>
                                    <strong class="text-success">Amrit</strong><br>
                                    <small class="text-muted">Nectar - Very auspicious</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-star fa-lg text-success me-2 me-md-3"></i>
                                <div>
                                    <strong class="text-success">Shubh</strong><br>
                                    <small class="text-muted">Auspicious - Good for all work</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-coins fa-lg text-success me-2 me-md-3"></i>
                                <div>
                                    <strong class="text-success">Labh</strong><br>
                                    <small class="text-muted">Profit - Good for business</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-route fa-lg text-secondary me-2 me-md-3"></i>
                                <div>
                                    <strong class="text-secondary">Chal</strong><br>
                                    <small class="text-muted">Movement - Good for travel</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-user-injured fa-lg text-danger me-2 me-md-3"></i>
                                <div>
                                    <strong class="text-danger">Rog</strong><br>
                                    <small class="text-muted">Illness - Health concerns</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-times-circle fa-lg text-danger me-2 me-md-3"></i>
                                <div>
                                    <strong class="text-danger">Udveg</strong><br>
                                    <small class="text-muted">Inauspicious - Avoid important tasks</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-exclamation-triangle fa-lg text-danger me-2 me-md-3"></i>
                                <div>
                                    <strong class="text-danger">Kaal</strong><br>
                                    <small class="text-muted">Very Inauspicious - Not favorable for new ventures</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info mt-3 mb-0">
                        <i class="fas fa-lightbulb me-2"></i>
                        <strong>Tip:</strong> Use <strong>Amrit</strong> and <strong>Shubh</strong> muhurats for important activities. 
                        Avoid <strong>Kaal</strong> and <strong>Udveg</strong> periods for new ventures.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Favorites Modal -->
    <div class="modal fade" id="favoritesModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-star me-2"></i>Favorite Locations</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="favoritesList"></div>
                    <div class="text-muted text-center py-3" id="noFavorites" style="display: none;">
                        <i class="fas fa-info-circle me-2"></i>No saved locations yet
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal fade" id="shareModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-share-alt me-2"></i>Share Chaughadiya</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-success" id="exportImageBtn">
                            <i class="fas fa-image me-2"></i>Export as Image
                        </button>
                        <button class="btn btn-info" id="exportCsvBtn">
                            <i class="fas fa-file-csv me-2"></i>Export as CSV
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Creative Footer -->
    <footer class="creative-footer">
        <div class="container">
            <div class="footer-content">
                <!-- Decorative Divider -->
                <div class="footer-divider">
                    <div class="footer-divider-line"></div>
                    <span class="footer-divider-icon">üïâÔ∏è</span>
                    <div class="footer-divider-line"></div>
                </div>

                <!-- Main Attribution -->
                <div class="footer-text">
                    <span>Crafted with</span>
                    <span class="footer-heart">‚ù§Ô∏è</span>
                    <span>by</span>
                    <div class="footer-link-container" id="footerFlipCard">
                        <div class="footer-link">
                            <div class="footer-link-front">
                                <i class="fab fa-github footer-icon"></i>
                                <span>codechaser</span>
                            </div>
                            <div class="footer-link-back">
                                <i class="fas fa-user footer-icon"></i>
                                <span>Yashvardhan Baid</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Subtitle -->
                <div class="footer-subtext">
                    <span>Empowering auspicious decisions through ancient Vedic wisdom</span>
                </div>

                <!-- Inspirational Quote -->
                <div class="footer-quote">
                    <i class="fas fa-quote-left me-2"></i>
                    ‡§ï‡§æ‡§≤‡§∏‡•ç‡§Ø ‡§Æ‡§π‡§ø‡§Æ‡§æ ‡§Æ‡§π‡§æ‡§®‡•ç | Time is the greatest force
                    <i class="fas fa-quote-right ms-2"></i>
                </div>
            </div>
        </div>
    </footer>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Popperjs -->

    <!-- Popperjs -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha256-BRqBN7dYgABqtY9Hd4ynE+1slnEw+roEPFzQ7TRRfcg=" crossorigin="anonymous"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const themeSwitcher = document.getElementById('themeSwitcher');
            const timeFormatSwitcher = document.getElementById('timeFormatSwitcher');
            const htmlElement = document.documentElement;
            let is24HourFormat = false;

            // Footer flip card functionality
            const footerFlipCard = document.getElementById('footerFlipCard');
            if (footerFlipCard) {
                footerFlipCard.addEventListener('click', function() {
                    const card = this.querySelector('.footer-link');
                    card.classList.toggle('flipped');
                });
            }

            // Load saved preferences
            function loadPreferences() {
                const savedDarkMode = localStorage.getItem('chaughadiya_darkMode') === 'true';
                const saved24Hour = localStorage.getItem('chaughadiya_24hour') === 'true';
                
                if (savedDarkMode) {
                    themeSwitcher.checked = true;
                    htmlElement.setAttribute('data-bs-theme', 'dark');
                }
                
                if (saved24Hour) {
                    timeFormatSwitcher.checked = true;
                    is24HourFormat = true;
                }
            }

            // Save preference helper
            function savePreference(key, value) {
                localStorage.setItem(`chaughadiya_${key}`, value);
            }

            themeSwitcher.addEventListener('change', function () {
                if (this.checked) {
                    htmlElement.setAttribute('data-bs-theme', 'dark');
                    savePreference('darkMode', 'true');
                } else {
                    htmlElement.setAttribute('data-bs-theme', 'light');
                    savePreference('darkMode', 'false');
                }
            });

            timeFormatSwitcher.addEventListener('change', function () {
                is24HourFormat = this.checked;
                savePreference('24hour', this.checked ? 'true' : 'false');
                // Re-render results if they exist
                if (window.currentData && window.currentTimezone) {
                    displayResults(window.currentData, window.currentTimezone);
                }
            });

            // Load preferences on page load
            loadPreferences();

            // Initialize favorites and share functionality
            const favoritesBtn = document.getElementById('favoritesBtn');
            const shareBtn = document.getElementById('shareBtn');
            const favoritesModal = new bootstrap.Modal(document.getElementById('favoritesModal'));
            const shareModal = new bootstrap.Modal(document.getElementById('shareModal'));

            favoritesBtn.addEventListener('click', () => {
                updateFavoritesList();
                favoritesModal.show();
            });

            shareBtn.addEventListener('click', async () => {
                if (!lastApiResponse) {
                    alert('Please fetch chaughadiya data first');
                    return;
                }
                
                // Show a quick action menu instead of just the modal
                // const choice = confirm('Generate shareable image card?\n\nOK = Generate & Download Image\nCancel = Show sharing options');
                
                const choice = false;
                if (choice) {
                    // Direct download
                    const btn = shareBtn;
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span class="d-none d-sm-inline ms-1">Generating...</span>';
                    btn.disabled = true;
                    
                    try {
                        const canvas = await generateShareableCard(lastApiResponse);
                        
                        canvas.toBlob(function(blob) {
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `chaughadiya-${lastApiResponse.date}-${locationInput.value.substring(0, 30).replace(/[^a-zA-Z0-9]/g, '-')}.png`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                            
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                            
                            // Show success message
                            const toast = document.createElement('div');
                            toast.className = 'position-fixed top-0 start-50 translate-middle-x mt-3 alert alert-success animate-fade-in';
                            toast.style.zIndex = '9999';
                            toast.innerHTML = '<i class="fas fa-check-circle me-2"></i>Image downloaded successfully!';
                            document.body.appendChild(toast);
                            setTimeout(() => {
                                toast.remove();
                            }, 3000);
                        }, 'image/png');
                    } catch (error) {
                        console.error('Error generating image:', error);
                        alert('Failed to generate image. Please try again.');
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                } else {
                    // Show modal with more options
                    shareModal.show();
                }
            });

            document.getElementById('exportCsvBtn').addEventListener('click', () => {
                exportToCSV();
            });

            document.getElementById('exportImageBtn').addEventListener('click', () => {
                exportAsImage();
            });

            // Load from URL if parameters present
            loadFromUrlParams();

            // Save favorite button handler
            document.getElementById('saveFavoriteBtn').addEventListener('click', () => {
                if (!latitude || !longitude) {
                    alert('Please select a location first');
                    return;
                }
                
                const name = locationInput.value || `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
                const timezone = timezoneSelect.value;
                saveFavorite(name, latitude, longitude, timezone);
            });

            // Live Muhurat Tracking
            let muhuratUpdateInterval = null;
            let clockUpdateInterval = null;

            function getCurrentMuhurat(data, userTimezone) {
                if (!data || !data.chaughadiya) return null;

                // Get current time in user's timezone
                const now = new Date();
                const timeString = now.toLocaleString('en-US', { 
                    timeZone: userTimezone, 
                    hour12: false, 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit' 
                });
                
                const [hours, minutes, seconds] = timeString.split(':').map(Number);
                const currentSeconds = hours * 3600 + minutes * 60 + seconds;

                // Find current muhurat
                for (let i = 0; i < data.chaughadiya.length; i++) {
                    const muhurat = data.chaughadiya[i];
                    const [startH, startM, startS] = muhurat['start-time'].split(':').map(Number);
                    const [endH, endM, endS] = muhurat['end-time'].split(':').map(Number);
                    
                    const startSeconds = startH * 3600 + startM * 60 + startS;
                    const endSeconds = endH * 3600 + endM * 60 + endS;
                    
                    // Handle midnight crossing
                    if (endSeconds < startSeconds) {
                        if (currentSeconds >= startSeconds || currentSeconds < endSeconds) {
                            return { muhurat, index: i, startSeconds, endSeconds };
                        }
                    } else {
                        if (currentSeconds >= startSeconds && currentSeconds < endSeconds) {
                            return { muhurat, index: i, startSeconds, endSeconds };
                        }
                    }
                }
                
                return null;
            }

            function formatCountdown(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                
                if (hours > 0) {
                    return `${hours}h ${minutes}m ${secs}s`;
                } else if (minutes > 0) {
                    return `${minutes}m ${secs}s`;
                } else {
                    return `${secs}s`;
                }
            }

            function updateLiveMuhurat() {
                if (!window.currentData || !window.currentTimezone) return;

                // Only update if viewing today's date
                if (!isDateTodayInTimezone(window.currentData.date, window.currentTimezone)) return;

                const current = getCurrentMuhurat(window.currentData, window.currentTimezone);
                if (!current) return;

                // Update current muhurat banner
                const banner = document.getElementById('current-muhurat-banner');
                if (banner) {
                    const now = new Date();
                    const timeString = now.toLocaleString('en-US', { 
                        timeZone: window.currentTimezone, 
                        hour12: false, 
                        hour: '2-digit', 
                        minute: '2-digit', 
                        second: '2-digit' 
                    });
                    
                    const [hours, minutes, seconds] = timeString.split(':').map(Number);
                    const currentSeconds = hours * 3600 + minutes * 60 + seconds;
                    
                    // Calculate time remaining
                    let timeRemaining;
                    if (current.endSeconds < current.startSeconds) {
                        // Crosses midnight
                        if (currentSeconds >= current.startSeconds) {
                            timeRemaining = (24 * 3600 - currentSeconds) + current.endSeconds;
                        } else {
                            timeRemaining = current.endSeconds - currentSeconds;
                        }
                    } else {
                        timeRemaining = current.endSeconds - currentSeconds;
                    }

                    // Calculate progress
                    let totalDuration;
                    if (current.endSeconds < current.startSeconds) {
                        totalDuration = (24 * 3600 - current.startSeconds) + current.endSeconds;
                    } else {
                        totalDuration = current.endSeconds - current.startSeconds;
                    }
                    const progress = ((totalDuration - timeRemaining) / totalDuration) * 100;

                    // Update clock
                    const clockElement = banner.querySelector('.live-clock');
                    if (clockElement) {
                        clockElement.textContent = formatTime(timeString, is24HourFormat);
                    }

                    // Update countdown
                    const countdownElement = banner.querySelector('.countdown-timer');
                    if (countdownElement) {
                        countdownElement.textContent = formatCountdown(timeRemaining);
                    }

                    // Update progress bar
                    const progressBar = banner.querySelector('.progress-bar-fill');
                    if (progressBar) {
                        progressBar.style.width = `${progress}%`;
                    }

                    // If muhurat changed, refresh display
                    if (window.lastMuhuratIndex !== current.index) {
                        window.lastMuhuratIndex = current.index;
                        displayResults(window.currentData, window.currentTimezone);
                    }
                }
            }

            function startLiveUpdates() {
                stopLiveUpdates();
                muhuratUpdateInterval = setInterval(updateLiveMuhurat, 1000);
            }

            function stopLiveUpdates() {
                if (muhuratUpdateInterval) {
                    clearInterval(muhuratUpdateInterval);
                    muhuratUpdateInterval = null;
                }
            }

            // Favorites Management
            function getFavorites() {
                const favorites = localStorage.getItem('chaughadiya_favorites');
                return favorites ? JSON.parse(favorites) : [];
            }

            function saveFavorite(name, lat, lng, timezone) {
                const favorites = getFavorites();
                
                // Check if already exists
                const exists = favorites.some(fav => fav.lat === lat && fav.lng === lng);
                if (exists) {
                    alert('This location is already in your favorites!');
                    return;
                }
                
                // Limit to 5 favorites
                if (favorites.length >= 5) {
                    alert('Maximum 5 favorite locations allowed. Please delete one to add new.');
                    return;
                }
                
                favorites.push({ name, lat, lng, timezone, addedAt: new Date().toISOString() });
                localStorage.setItem('chaughadiya_favorites', JSON.stringify(favorites));
                updateFavoritesList();
                alert('Location saved to favorites!');
            }

            function deleteFavorite(index) {
                if (!confirm('Remove this location from favorites?')) return;
                
                const favorites = getFavorites();
                favorites.splice(index, 1);
                localStorage.setItem('chaughadiya_favorites', JSON.stringify(favorites));
                updateFavoritesList();
            }

            function loadFavorite(favorite) {
                locationInput.value = favorite.name;
                latitude = favorite.lat;
                longitude = favorite.lng;
                marker.setLatLng([latitude, longitude]);
                map.setView([latitude, longitude], 10);
                
                if (favorite.timezone) {
                    timezoneSelect.value = favorite.timezone;
                }
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('favoritesModal'));
                if (modal) modal.hide();
            }

            function updateFavoritesList() {
                const favorites = getFavorites();
                const listEl = document.getElementById('favoritesList');
                const noFavEl = document.getElementById('noFavorites');
                
                if (favorites.length === 0) {
                    listEl.innerHTML = '';
                    noFavEl.style.display = 'block';
                    return;
                }
                
                noFavEl.style.display = 'none';
                listEl.innerHTML = favorites.map((fav, index) => `
                    <div class="card mb-2">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="flex-grow-1" style="cursor: pointer;" onclick="loadFavorite(getFavorites()[${index}])">
                                    <strong>${fav.name}</strong><br>
                                    <small class="text-muted">${fav.timezone || 'No timezone'}</small>
                                </div>
                                <button class="btn btn-sm btn-danger" onclick="deleteFavorite(${index})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            // Share functionality
            function generateShareUrl() {
                if (!window.currentData || !latitude || !longitude) return '';
                
                const params = new URLSearchParams({
                    date: window.currentData.date,
                    lat: latitude.toFixed(6),
                    lng: longitude.toFixed(6),
                    tz: window.currentTimezone,
                    location: locationInput.value
                });
                
                return `${window.location.origin}${window.location.pathname}?${params.toString()}`;
            }

            function copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    const btn = document.getElementById('copyUrlBtn');
                    const originalHtml = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-success');
                    setTimeout(() => {
                        btn.innerHTML = originalHtml;
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-primary');
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    alert('Failed to copy link. Please copy manually.');
                });
            }

            // Export to CSV
            function exportToCSV() {
                if (!window.currentData || !window.currentData.chaughadiya) {
                    alert('No data to export');
                    return;
                }
                
                const data = window.currentData.chaughadiya;
                let csv = 'Serial,Muhurat,Start Time,End Time,Period\n';
                
                // Helper to determine day/night based on sunrise/sunset
                const timeToSeconds = (timeStr) => {
                    const [h, m, s] = timeStr.split(':').map(Number);
                    return h * 3600 + m * 60 + s;
                };
                const sunriseSeconds = timeToSeconds(window.currentData['sunrise-time']);
                const sunsetSeconds = timeToSeconds(window.currentData['sunset-time']);
                
                data.forEach((muhurat, index) => {
                    const muhuratSeconds = timeToSeconds(muhurat['start-time']);
                    const isDay = sunsetSeconds < sunriseSeconds 
                        ? (muhuratSeconds >= sunriseSeconds || muhuratSeconds < sunsetSeconds)
                        : (muhuratSeconds >= sunriseSeconds && muhuratSeconds < sunsetSeconds);
                    const period = isDay ? 'Day' : 'Night';
                    csv += `${index + 1},${muhurat.muhurat},${muhurat['start-time']},${muhurat['end-time']},${period}\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `chaughadiya_${window.currentData.date}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
            }

            // Export as image - generates a beautiful shareable card
            async function exportAsImage() {
                if (!lastApiResponse) {
                    alert('Please fetch chaughadiya data first');
                    return;
                }
                
                // Show loading state
                const btn = document.getElementById('exportImageBtn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
                btn.disabled = true;
                
                try {
                    const canvas = await generateShareableCard(lastApiResponse);
                    
                    // Convert canvas to blob and download
                    canvas.toBlob(function(blob) {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `chaughadiya-${lastApiResponse.date}-${locationInput.value.substring(0, 30)}.png`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                        // Reset button state
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }, 'image/png');
                } catch (error) {
                    console.error('Error generating image:', error);
                    alert('Failed to generate image. Please try again.');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
            
            // Generate professional shareable card with elegant table design
            async function generateShareableCard(data) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // High resolution canvas for better quality - dynamic height based on muhurats
                const scale = 2;
                const width = 1200;
                const muhuratCount = data.chaughadiya.length;
                const rowHeight = 45;
                const baseHeight = 670; // Header + info + stats + timeline + footer (with creator credit) + padding
                const height = baseHeight + (muhuratCount * rowHeight);
                
                canvas.width = width * scale;
                canvas.height = height * scale;
                ctx.scale(scale, scale);
                
                
                // Current theme
                const isDarkTheme = document.documentElement.getAttribute('data-bs-theme') === 'dark';
                
                // Professional color palette
                const colors = {
                    primary: '#FF9933',
                    secondary: '#800000',
                    accent: '#138808',
                    background: isDarkTheme ? '#1a1d29' : '#FFFFFF',
                    headerBg: '#800000',
                    cardBg: isDarkTheme ? '#2c3e50' : '#FFFFFF',
                    text: isDarkTheme ? '#ECF0F1' : '#1a1a1a',
                    textSecondary: isDarkTheme ? '#BDC3C7' : '#555555',
                    border: isDarkTheme ? '#555555' : '#DDDDDD',
                    tableBorder: isDarkTheme ? '#444444' : '#CCCCCC',
                    tableHeader: isDarkTheme ? '#34495e' : '#F5F5F5',
                    success: '#28a745',
                    danger: '#dc3545',
                    info: '#17a2b8',
                    lightBg: '#F9F9F9'
                };
                
                // Muhurat info with colors and meanings
                const muhuratInfo = {
                    'Amrit': { color: colors.success, bg: '#d4edda', icon: '‚úì', meaning: 'Auspicious' },
                    'Shubh': { color: colors.success, bg: '#d4edda', icon: '‚úì', meaning: 'Auspicious' },
                    'Labh': { color: colors.success, bg: '#d4edda', icon: '‚úì', meaning: 'Auspicious' },
                    'Chal': { color: colors.info, bg: '#d1ecf1', icon: '‚óã', meaning: 'Neutral' },
                    'Udveg': { color: colors.danger, bg: '#f8d7da', icon: '‚úó', meaning: 'Inauspicious' },
                    'Kaal': { color: colors.danger, bg: '#f8d7da', icon: '‚úó', meaning: 'Inauspicious' },
                    'Rog': { color: colors.danger, bg: '#f8d7da', icon: '‚úó', meaning: 'Inauspicious' }
                };
                
                // Clean background
                ctx.fillStyle = colors.background;
                ctx.fillRect(0, 0, width, height);
                
                // Header section with brand
                const headerHeight = 100;
                ctx.fillStyle = colors.headerBg;
                ctx.fillRect(0, 0, width, headerHeight);
                
                // Accent line under header
                ctx.fillStyle = colors.primary;
                ctx.fillRect(0, headerHeight, width, 4);
                
                // Title - matching website header
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 48px Arial, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('‚òÄÔ∏è Chaughadiya üåô', width / 2, 65);
                
                // Content area
                let yPos = headerHeight + 40;
                const margin = 60;
                const contentWidth = width - (margin * 2);
                
                // Date - larger and prominent
                ctx.fillStyle = colors.text;
                ctx.font = 'bold 34px Arial, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(formatDateForDisplay(data.date), width / 2, yPos);
                
                yPos += 40;
                
                // Location
                ctx.font = '22px Arial, sans-serif';
                ctx.fillStyle = colors.textSecondary;
                const locationText = locationInput.value || `${latitude.toFixed(4)}¬∞, ${longitude.toFixed(4)}¬∞`;
                ctx.fillText('üìç ' + truncateText(locationText, 60), width / 2, yPos);
                
                yPos += 35;
                
                // Timezone info
                ctx.font = '18px Arial, sans-serif';
                ctx.fillStyle = colors.textSecondary;
                ctx.fillText(`üåç ${timezoneSelect.value}`, width / 2, yPos);
                
                yPos += 45;
                
                // Sunrise and Sunset info box - enhanced
                const sunInfoBoxHeight = 65;
                const sunInfoBoxY = yPos;
                
                // Background box for sun info
                ctx.fillStyle = isDarkTheme ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.03)';
                ctx.fillRect(margin, sunInfoBoxY, contentWidth, sunInfoBoxHeight);
                
                // Border
                ctx.strokeStyle = colors.border;
                ctx.lineWidth = 1;
                ctx.strokeRect(margin, sunInfoBoxY, contentWidth, sunInfoBoxHeight);
                
                // Sunrise section
                ctx.font = 'bold 18px Arial, sans-serif';
                ctx.fillStyle = '#FF8C00';
                ctx.textAlign = 'center';
                ctx.fillText('‚òÄÔ∏è SUNRISE', margin + contentWidth * 0.25, sunInfoBoxY + 25);
                ctx.fillStyle = colors.text;
                ctx.font = 'bold 24px Courier New, monospace';
                ctx.fillText(formatTime(roundTimeToMinute(data['sunrise-time']), is24HourFormat), 
                    margin + contentWidth * 0.25, sunInfoBoxY + 50);
                
                // Vertical divider
                ctx.strokeStyle = colors.border;
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(width / 2, sunInfoBoxY + 10);
                ctx.lineTo(width / 2, sunInfoBoxY + sunInfoBoxHeight - 10);
                ctx.stroke();
                
                // Sunset section
                ctx.font = 'bold 18px Arial, sans-serif';
                ctx.fillStyle = '#FF6347';
                ctx.fillText('üåô SUNSET', margin + contentWidth * 0.75, sunInfoBoxY + 25);
                ctx.fillStyle = colors.text;
                ctx.font = 'bold 24px Courier New, monospace';
                ctx.fillText(formatTime(roundTimeToMinute(data['sunset-time']), is24HourFormat), 
                    margin + contentWidth * 0.75, sunInfoBoxY + 50);
                
                yPos += sunInfoBoxHeight + 40;
                
                // Quick Statistics Bar
                const muhuratCounts = {
                    'Auspicious': 0,
                    'Neutral': 0,
                    'Inauspicious': 0
                };
                
                data.chaughadiya.forEach(m => {
                    if (['Amrit', 'Shubh', 'Labh'].includes(m.muhurat)) {
                        muhuratCounts['Auspicious']++;
                    } else if (['Udveg', 'Kaal', 'Rog'].includes(m.muhurat)) {
                        muhuratCounts['Inauspicious']++;
                    } else {
                        muhuratCounts['Neutral']++;
                    }
                });
                
                // Stats boxes
                const statsBoxHeight = 55;
                const statsBoxWidth = (contentWidth - 40) / 3;
                
                // Auspicious box
                ctx.fillStyle = colors.success + '15';
                ctx.fillRect(margin, yPos, statsBoxWidth, statsBoxHeight);
                ctx.strokeStyle = colors.success;
                ctx.lineWidth = 2;
                ctx.strokeRect(margin, yPos, statsBoxWidth, statsBoxHeight);
                
                ctx.fillStyle = colors.success;
                ctx.font = 'bold 24px Arial, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(muhuratCounts['Auspicious'], margin + statsBoxWidth / 2, yPos + 25);
                ctx.font = '14px Arial, sans-serif';
                ctx.fillText('Auspicious', margin + statsBoxWidth / 2, yPos + 45);
                
                // Neutral box
                ctx.fillStyle = colors.info + '15';
                ctx.fillRect(margin + statsBoxWidth + 20, yPos, statsBoxWidth, statsBoxHeight);
                ctx.strokeStyle = colors.info;
                ctx.lineWidth = 2;
                ctx.strokeRect(margin + statsBoxWidth + 20, yPos, statsBoxWidth, statsBoxHeight);
                
                ctx.fillStyle = colors.info;
                ctx.font = 'bold 24px Arial, sans-serif';
                ctx.fillText(muhuratCounts['Neutral'], margin + statsBoxWidth + 20 + statsBoxWidth / 2, yPos + 25);
                ctx.font = '14px Arial, sans-serif';
                ctx.fillText('Neutral', margin + statsBoxWidth + 20 + statsBoxWidth / 2, yPos + 45);
                
                // Inauspicious box
                ctx.fillStyle = colors.danger + '15';
                ctx.fillRect(margin + (statsBoxWidth + 20) * 2, yPos, statsBoxWidth, statsBoxHeight);
                ctx.strokeStyle = colors.danger;
                ctx.lineWidth = 2;
                ctx.strokeRect(margin + (statsBoxWidth + 20) * 2, yPos, statsBoxWidth, statsBoxHeight);
                
                ctx.fillStyle = colors.danger;
                ctx.font = 'bold 24px Arial, sans-serif';
                ctx.fillText(muhuratCounts['Inauspicious'], margin + (statsBoxWidth + 20) * 2 + statsBoxWidth / 2, yPos + 25);
                ctx.font = '14px Arial, sans-serif';
                ctx.fillText('Inauspicious', margin + (statsBoxWidth + 20) * 2 + statsBoxWidth / 2, yPos + 45);
                
                yPos += statsBoxHeight + 40;
                
                // Table Header
                const tableX = margin;
                const colWidths = [80, 270, 250, 250, 227]; // Serial, Muhurat, Start, End, Period
                const tableWidth = colWidths.reduce((a, b) => a + b, 0);
                
                // Shadow effect for table
                ctx.shadowColor = 'rgba(0, 0, 0, 0.1)';
                ctx.shadowBlur = 10;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 2;
                
                // Draw table header background
                ctx.fillStyle = colors.tableHeader;
                ctx.fillRect(tableX, yPos, tableWidth, rowHeight);
                
                // Reset shadow
                ctx.shadowColor = 'transparent';
                ctx.shadowBlur = 0;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;
                
                // Table header border
                ctx.strokeStyle = colors.tableBorder;
                ctx.lineWidth = 2;
                ctx.strokeRect(tableX, yPos, tableWidth, rowHeight);
                
                // Draw vertical column dividers in header
                let xPos = tableX;
                for (let i = 0; i < colWidths.length - 1; i++) {
                    xPos += colWidths[i];
                    ctx.beginPath();
                    ctx.moveTo(xPos, yPos);
                    ctx.lineTo(xPos, yPos + rowHeight);
                    ctx.stroke();
                }
                
                // Table header text
                ctx.fillStyle = colors.text;
                ctx.font = 'bold 18px Arial, sans-serif';
                ctx.textAlign = 'center';
                
                const headers = ['#', 'Muhurat', 'Start Time', 'End Time', 'Period'];
                xPos = tableX;
                headers.forEach((header, index) => {
                    ctx.fillText(header, xPos + colWidths[index] / 2, yPos + 28);
                    xPos += colWidths[index];
                });
                
                yPos += rowHeight;
                
                // Helper to determine day/night with error handling
                const timeToSeconds = (timeStr) => {
                    if (!timeStr || typeof timeStr !== 'string') {
                        console.warn('Invalid time string:', timeStr);
                        return 0;
                    }
                    const parts = timeStr.split(':');
                    if (parts.length !== 3) {
                        console.warn('Invalid time format:', timeStr);
                        return 0;
                    }
                    const [h, m, s] = parts.map(Number);
                    return h * 3600 + m * 60 + s;
                };
                const sunriseSeconds = timeToSeconds(data['sunrise-time']);
                const sunsetSeconds = timeToSeconds(data['sunset-time']);
                
                // Check if viewing today's date (needed for timeline and current muhurat)
                const isTodayInTimezone = isDateTodayInTimezone(data.date, timezoneSelect.value);
                
                // Draw table rows
                data.chaughadiya.forEach((muhurat, index) => {
                    const muhuratSeconds = timeToSeconds(muhurat['start-time']);
                    const isDay = sunsetSeconds < sunriseSeconds 
                        ? (muhuratSeconds >= sunriseSeconds || muhuratSeconds < sunsetSeconds)
                        : (muhuratSeconds >= sunriseSeconds && muhuratSeconds < sunsetSeconds);
                    const period = isDay ? '‚òÄÔ∏è Day' : 'üåô Night';
                    
                    const info = muhuratInfo[muhurat.muhurat] || { color: colors.info, bg: '#e7f3f8', icon: '‚óã', meaning: 'Neutral' };
                    
                    // Calculate duration
                    const startSeconds = timeToSeconds(muhurat['start-time']);
                    const endSeconds = timeToSeconds(muhurat['end-time']);
                    let durationSeconds = endSeconds - startSeconds;
                    if (durationSeconds < 0) durationSeconds += 86400; // Handle midnight crossing
                    const hours = Math.floor(durationSeconds / 3600);
                    const minutes = Math.floor((durationSeconds % 3600) / 60);
                    const durationText = `${hours}h ${minutes}m`;
                    
                    // Highlight current muhurat
                    const currentMuhuratData = isTodayInTimezone ? getCurrentMuhurat(data, timezoneSelect.value) : null;
                    const isCurrent = currentMuhuratData && currentMuhuratData.muhurat.muhurat === muhurat.muhurat &&
                                     currentMuhuratData.muhurat['start-time'] === muhurat['start-time'];
                    
                    // Row background - alternate colors
                    if (isCurrent) {
                        ctx.fillStyle = info.bg;
                    } else {
                        ctx.fillStyle = index % 2 === 0 ? colors.background : (isDarkTheme ? '#252b38' : '#FAFAFA');
                    }
                    ctx.fillRect(tableX, yPos, tableWidth, rowHeight);
                    
                    // Left border accent for current muhurat
                    if (isCurrent) {
                        ctx.fillStyle = info.color;
                        ctx.fillRect(tableX, yPos, 5, rowHeight);
                    }
                    
                    // Row border
                    ctx.strokeStyle = colors.tableBorder;
                    ctx.lineWidth = 1;
                    ctx.strokeRect(tableX, yPos, tableWidth, rowHeight);
                    
                    // Draw vertical column dividers
                    xPos = tableX;
                    for (let i = 0; i < colWidths.length - 1; i++) {
                        xPos += colWidths[i];
                        ctx.strokeStyle = colors.tableBorder;
                        ctx.lineWidth = 0.5;
                        ctx.beginPath();
                        ctx.moveTo(xPos, yPos);
                        ctx.lineTo(xPos, yPos + rowHeight);
                        ctx.stroke();
                    }
                    
                    // Cell content
                    ctx.fillStyle = colors.text;
                    ctx.font = '17px Arial, sans-serif';
                    ctx.textAlign = 'center';
                    
                    xPos = tableX;
                    
                    // Serial number with circle background for current
                    if (isCurrent) {
                        ctx.fillStyle = info.color;
                        ctx.beginPath();
                        ctx.arc(xPos + colWidths[0] / 2, yPos + rowHeight / 2, 16, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.fillStyle = '#ffffff';
                        ctx.font = 'bold 17px Arial, sans-serif';
                    } else {
                        ctx.fillStyle = colors.textSecondary;
                    }
                    ctx.fillText(String(index + 1), xPos + colWidths[0] / 2, yPos + 28);
                    xPos += colWidths[0];
                    
                    // Muhurat name with icon and color
                    ctx.fillStyle = info.color;
                    ctx.font = 'bold 19px Arial, sans-serif';
                    ctx.fillText(`${info.icon} ${muhurat.muhurat}`, xPos + colWidths[1] / 2, yPos + 28);
                    xPos += colWidths[1];
                    
                    // Start time
                    ctx.fillStyle = colors.text;
                    ctx.font = '17px Courier New, monospace';
                    ctx.fillText(formatTime(roundTimeToMinute(muhurat['start-time']), is24HourFormat), 
                        xPos + colWidths[2] / 2, yPos + 28);
                    xPos += colWidths[2];
                    
                    // End time
                    ctx.fillText(formatTime(roundTimeToMinute(muhurat['end-time']), is24HourFormat), 
                        xPos + colWidths[3] / 2, yPos + 28);
                    xPos += colWidths[3];
                    
                    // Period
                    ctx.fillStyle = colors.textSecondary;
                    ctx.font = '17px Arial, sans-serif';
                    ctx.fillText(period, xPos + colWidths[4] / 2, yPos + 28);
                    
                    // Add "LIVE" pulse badge if it's the current muhurat
                    if (isCurrent) {
                        ctx.fillStyle = info.color;
                        ctx.font = 'bold 12px Arial, sans-serif';
                        ctx.textAlign = 'left';
                        
                        // Draw pulsing circle (simulated)
                        ctx.globalAlpha = 0.3;
                        ctx.beginPath();
                        ctx.arc(tableX + 15, yPos + 10, 8, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.globalAlpha = 1;
                        
                        ctx.beginPath();
                        ctx.arc(tableX + 15, yPos + 10, 5, 0, Math.PI * 2);
                        ctx.fill();
                        
                        ctx.fillStyle = '#ffffff';
                        ctx.font = 'bold 10px Arial, sans-serif';
                        ctx.textAlign = 'center';
                        ctx.fillText('‚óè', tableX + 15, yPos + 13);
                    }
                    
                    yPos += rowHeight;
                });
                
                // Footer with visual timeline
                yPos += 40;
                
                // Add a visual 24-hour timeline
                const timelineHeight = 60;
                const timelineY = yPos;
                const timelineWidth = contentWidth;
                
                // Timeline background
                ctx.fillStyle = isDarkTheme ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)';
                ctx.fillRect(margin, timelineY, timelineWidth, timelineHeight);
                
                // Timeline border
                ctx.strokeStyle = colors.border;
                ctx.lineWidth = 1;
                ctx.strokeRect(margin, timelineY, timelineWidth, timelineHeight);
                
                // Draw timeline label
                ctx.fillStyle = colors.text;
                ctx.font = 'bold 14px Arial, sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText('24-Hour Timeline:', margin + 10, timelineY + 18);
                
                // Draw muhurat blocks on timeline
                const timelineBarY = timelineY + 28;
                const timelineBarHeight = 25;
                const pixelsPerSecond = timelineWidth / 86400; // 24 hours in seconds
                
                data.chaughadiya.forEach((muhurat, index) => {
                    const info = muhuratInfo[muhurat.muhurat] || { color: colors.info, bg: '#e7f3f8', icon: '‚óã', meaning: 'Neutral' };
                    const startSeconds = timeToSeconds(muhurat['start-time']);
                    const endSeconds = timeToSeconds(muhurat['end-time']);
                    let durationSeconds = endSeconds - startSeconds;
                    if (durationSeconds < 0) durationSeconds += 86400;
                    
                    const blockX = margin + (startSeconds * pixelsPerSecond);
                    const blockWidth = durationSeconds * pixelsPerSecond;
                    
                    ctx.fillStyle = info.color + '80'; // Semi-transparent
                    ctx.fillRect(blockX, timelineBarY, blockWidth, timelineBarHeight);
                    
                    // Block border
                    ctx.strokeStyle = info.color;
                    ctx.lineWidth = 0.5;
                    ctx.strokeRect(blockX, timelineBarY, blockWidth, timelineBarHeight);
                });
                
                // Add sunrise and sunset markers
                const sunriseSecondsTimeline = timeToSeconds(data['sunrise-time']);
                const sunsetSecondsTimeline = timeToSeconds(data['sunset-time']);
                
                // Sunrise marker
                const sunriseX = margin + (sunriseSecondsTimeline * pixelsPerSecond);
                ctx.strokeStyle = '#FF8C00';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(sunriseX, timelineBarY);
                ctx.lineTo(sunriseX, timelineBarY + timelineBarHeight);
                ctx.stroke();
                
                // Sunset marker
                const sunsetX = margin + (sunsetSecondsTimeline * pixelsPerSecond);
                ctx.strokeStyle = '#FF6347';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(sunsetX, timelineBarY);
                ctx.lineTo(sunsetX, timelineBarY + timelineBarHeight);
                ctx.stroke();
                
                // Current time marker if today
                if (isTodayInTimezone) {
                    try {
                        const now = new Date();
                        const timeString = now.toLocaleString('en-US', { 
                            timeZone: timezoneSelect.value, 
                            hour12: false, 
                            hour: '2-digit', 
                            minute: '2-digit', 
                            second: '2-digit' 
                        });
                        
                        // Extract time portion (format can vary, so handle both "date, time" and just "time")
                        let currentTime;
                        if (timeString.includes(',')) {
                            currentTime = timeString.split(', ')[1];
                        } else {
                            // If no comma, try to extract just the time part
                            const timeParts = timeString.match(/(\d{2}):(\d{2}):(\d{2})/);
                            if (timeParts) {
                                currentTime = `${timeParts[1]}:${timeParts[2]}:${timeParts[3]}`;
                            }
                        }
                        
                        if (currentTime) {
                            const currentSeconds = timeToSeconds(currentTime);
                            const currentX = margin + (currentSeconds * pixelsPerSecond);
                            
                            // Draw pulsing marker
                            ctx.strokeStyle = '#FF0000';
                            ctx.lineWidth = 3;
                            ctx.beginPath();
                            ctx.moveTo(currentX, timelineBarY - 5);
                            ctx.lineTo(currentX, timelineBarY + timelineBarHeight + 5);
                            ctx.stroke();
                            
                            // Arrow at top
                            ctx.fillStyle = '#FF0000';
                            ctx.beginPath();
                            ctx.moveTo(currentX, timelineBarY - 5);
                            ctx.lineTo(currentX - 5, timelineBarY - 10);
                            ctx.lineTo(currentX + 5, timelineBarY - 10);
                            ctx.closePath();
                            ctx.fill();
                        }
                    } catch (error) {
                        console.warn('Could not draw current time marker:', error);
                    }
                }
                
                yPos += timelineHeight + 30;
                
                // Footer text with creator credit
                ctx.fillStyle = colors.textSecondary;
                ctx.font = '15px Arial, sans-serif';
                ctx.textAlign = 'center';
                
                // Main line
                ctx.fillText('Generated by Chaughadiya App  ‚Ä¢  ' + new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }), width / 2, yPos);
                
                yPos += 22;
                
                // Creator credit - subtle and smaller
                ctx.font = '13px Arial, sans-serif';
                ctx.fillStyle = isDarkTheme ? 'rgba(255, 255, 255, 0.4)' : 'rgba(0, 0, 0, 0.4)';
                ctx.fillText('created by codechaser / Yashvardhan Baid', width / 2, yPos);
                
                return canvas;
            }
            
            // Helper function to draw rounded rectangles
            function roundRect(ctx, x, y, width, height, radius) {
                ctx.beginPath();
                ctx.moveTo(x + radius, y);
                ctx.lineTo(x + width - radius, y);
                ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
                ctx.lineTo(x + width, y + height - radius);
                ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
                ctx.lineTo(x + radius, y + height);
                ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
                ctx.lineTo(x, y + radius);
                ctx.quadraticCurveTo(x, y, x + radius, y);
                ctx.closePath();
            }
            
            // Helper function to format date for display
            function formatDateForDisplay(dateString) {
                const date = new Date(dateString + 'T00:00:00');
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                return date.toLocaleDateString('en-US', options);
            }
            
            // Helper function to truncate text
            function truncateText(text, maxLength) {
                if (text.length <= maxLength) return text;
                return text.substring(0, maxLength - 3) + '...';
            }
            
            // Helper function to find next auspicious muhurat
            function findNextAuspiciousMuhurat(data, userTimezone) {
                if (!isDateTodayInTimezone(data.date, userTimezone)) {
                    return null;
                }
                
                const now = new Date();
                const currentTime = now.toLocaleString('en-US', { 
                    timeZone: userTimezone, 
                    hour12: false, 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit' 
                }).split(', ')[1];
                
                const auspiciousMuhurats = ['Amrit', 'Shubh', 'Labh'];
                
                for (const muhurat of data.chaughadiya) {
                    if (auspiciousMuhurats.includes(muhurat.muhurat) && 
                        muhurat['start-time'] > currentTime) {
                        return muhurat;
                    }
                }
                
                return null;
            }

            // Load from URL parameters
            function loadFromUrlParams() {
                const params = new URLSearchParams(window.location.search);
                
                if (params.has('date') && params.has('lat') && params.has('lng')) {
                    const date = params.get('date');
                    const lat = parseFloat(params.get('lat'));
                    const lng = parseFloat(params.get('lng'));
                    const tz = params.get('tz');
                    const location = params.get('location');
                    
                    // Parse date
                    const [year, month, day] = date.split('-');
                    daySelect.value = parseInt(day);
                    monthSelect.value = parseInt(month);
                    yearSelect.value = parseInt(year);
                    
                    // Set location
                    latitude = lat;
                    longitude = lng;
                    if (location) locationInput.value = decodeURIComponent(location);
                    marker.setLatLng([lat, lng]);
                    map.setView([lat, lng], 10);
                    
                    // Set timezone
                    if (tz && timezoneSelect.querySelector(`option[value="${tz}"]`)) {
                        timezoneSelect.value = tz;
                    }
                    
                    // Auto-submit
                    setTimeout(() => form.dispatchEvent(new Event('submit')), 1000);
                }
            }

            const locationInput = document.getElementById('location');
            const daySelect = document.getElementById('day');
            const monthSelect = document.getElementById('month');
            const yearSelect = document.getElementById('year');
            const timezoneSelect = document.getElementById('timezone');
            const form = document.getElementById('chaughadiya-form');
            const resultsContainer = document.getElementById('results-container');
            let latitude, longitude;
            let searchTimeout;
            let lastApiResponse = null; // Store last response for sharing

            // Initialize date dropdowns
            function initializeDateDropdowns() {
                // Populate days (1-31)
                for (let day = 1; day <= 31; day++) {
                    const option = document.createElement('option');
                    option.value = day;
                    option.textContent = day;
                    daySelect.appendChild(option);
                }

                // Populate years (current year - 10 to current year + 10)
                const currentYear = new Date().getFullYear();
                for (let year = currentYear - 10; year <= currentYear + 10; year++) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                }

                // Set current date as default
                const today = new Date();
                daySelect.value = today.getDate();
                monthSelect.value = today.getMonth() + 1;
                yearSelect.value = today.getFullYear();
            }

            initializeDateDropdowns();

            // Add location search functionality
            locationInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const query = this.value.trim();
                
                if (query.length < 3) {
                    hideLocationSuggestions();
                    return;
                }

                searchTimeout = setTimeout(() => {
                    searchLocations(query);
                }, 300);
            });

            function searchLocations(query) {
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Location search service unavailable');
                        }
                        return response.json();
                    })
                    .then(data => {
                        showLocationSuggestions(data);
                    })
                    .catch(error => {
                        console.error('Location search error:', error);
                        hideLocationSuggestions();
                        // Show a temporary error message
                        const errorMsg = document.createElement('div');
                        errorMsg.className = 'alert alert-warning alert-dismissible fade show mt-2';
                        errorMsg.innerHTML = `
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Location search temporarily unavailable. Please try selecting on the map.
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        locationInput.parentNode.appendChild(errorMsg);
                        setTimeout(() => errorMsg.remove(), 5000);
                    });
            }

            function showLocationSuggestions(locations) {
                hideLocationSuggestions(); // Remove any existing suggestions
                
                if (locations.length === 0) return;

                const suggestionsDiv = document.createElement('div');
                suggestionsDiv.className = 'list-group position-absolute w-100';
                suggestionsDiv.style.zIndex = '1000';
                suggestionsDiv.id = 'location-suggestions';

                locations.forEach(location => {
                    const item = document.createElement('button');
                    item.type = 'button';
                    item.className = 'list-group-item list-group-item-action';
                    item.textContent = location.display_name;
                    item.addEventListener('click', () => {
                        selectLocation(location);
                    });
                    suggestionsDiv.appendChild(item);
                });

                locationInput.parentNode.style.position = 'relative';
                locationInput.parentNode.appendChild(suggestionsDiv);
            }

            function hideLocationSuggestions() {
                const suggestions = document.getElementById('location-suggestions');
                if (suggestions) {
                    suggestions.remove();
                }
            }

            function selectLocation(location) {
                locationInput.value = location.display_name;
                latitude = parseFloat(location.lat);
                longitude = parseFloat(location.lon);
                
                // Update map
                marker.setLatLng([latitude, longitude]);
                map.setView([latitude, longitude], 10);
                
                hideLocationSuggestions();
            }

            // Hide suggestions when clicking outside
            document.addEventListener('click', function(event) {
                if (!locationInput.contains(event.target) && !document.getElementById('location-suggestions')?.contains(event.target)) {
                    hideLocationSuggestions();
                }
            });

            function fetchLocation() {
                if ('geolocation' in navigator) {
                    navigator.geolocation.getCurrentPosition(async (position) => {
                        latitude = position.coords.latitude;
                        longitude = position.coords.longitude;
                        
                        marker.setLatLng([latitude, longitude]);
                        map.setView([latitude, longitude], 10);
                        
                        try {
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                            if (!response.ok) throw new Error('Geocoding service unavailable');
                            const data = await response.json();
                            if (data && data.display_name) {
                                locationInput.value = data.display_name;
                            }
                        } catch (error) {
                            console.error('Error fetching location name:', error);
                            locationInput.value = `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
                        }
                    }, (error) => {
                        console.error('Error getting location:', error);
                        let errorMessage = "Could not fetch location. ";
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage += "Permission denied.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage += "Position unavailable.";
                                break;
                            case error.TIMEOUT:
                                errorMessage += "Request timed out.";
                                break;
                            default:
                                errorMessage += "Unknown error.";
                        }
                        locationInput.placeholder = errorMessage + " Please search or click on map.";
                    });
                } else {
                    console.error('Geolocation is not supported by this browser.');
                    locationInput.placeholder = "Geolocation not supported. Please search or click on map.";
                }
            }

            fetchLocation();

            const map = L.map('map').setView([20.5937, 78.9629], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            let marker = L.marker([20.5937, 78.9629]).addTo(map);

            map.on('click', function(e) {
                latitude = e.latlng.lat;
                longitude = e.latlng.lng;
                marker.setLatLng(e.latlng);
                updateLocationInput(latitude, longitude);
            });

            async function updateLocationInput(lat, lng) {
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                    if (!response.ok) throw new Error('Geocoding service unavailable');
                    const data = await response.json();
                    if (data && data.display_name) {
                        locationInput.value = data.display_name;
                    } else {
                        locationInput.value = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                    }
                } catch (error) {
                    console.error('Error updating location:', error);
                    locationInput.value = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                }
            }

            const timezones = Intl.supportedValuesOf('timeZone');
            timezones.forEach(tz => {
                const option = document.createElement('option');
                option.value = tz;
                option.textContent = tz;
                timezoneSelect.appendChild(option);
            });
            const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            timezoneSelect.value = userTimezone;

            form.addEventListener('submit', async function(event) {
                event.preventDefault();
                const day = daySelect.value;
                const month = monthSelect.value;
                const year = yearSelect.value;
                const timezone = timezoneSelect.value;

                // Validate all required fields
                if (!day || !month || !year) {
                    resultsContainer.innerHTML = '<div class="alert alert-danger animate-fade-in"><i class="fas fa-exclamation-triangle me-2"></i>Please select a complete date.</div>';
                    return;
                }

                if (!latitude || !longitude) {
                    resultsContainer.innerHTML = '<div class="alert alert-danger animate-fade-in"><i class="fas fa-exclamation-triangle me-2"></i>Please select a location on the map or search for one.</div>';
                    return;
                }

                if (!timezone) {
                    resultsContainer.innerHTML = '<div class="alert alert-danger animate-fade-in"><i class="fas fa-exclamation-triangle me-2"></i>Please select a timezone.</div>';
                    return;
                }

                // Validate date is valid (e.g., not Feb 30)
                const testDate = new Date(year, month - 1, day);
                if (testDate.getMonth() + 1 !== parseInt(month) || testDate.getDate() !== parseInt(day)) {
                    resultsContainer.innerHTML = '<div class="alert alert-danger animate-fade-in"><i class="fas fa-exclamation-triangle me-2"></i>Invalid date. Please check your selection.</div>';
                    return;
                }

                // Validate coordinates
                if (latitude < -90 || latitude > 90) {
                    resultsContainer.innerHTML = '<div class="alert alert-danger animate-fade-in"><i class="fas fa-exclamation-triangle me-2"></i>Invalid latitude. Please select a valid location.</div>';
                    return;
                }

                if (longitude < -180 || longitude > 180) {
                    resultsContainer.innerHTML = '<div class="alert alert-danger animate-fade-in"><i class="fas fa-exclamation-triangle me-2"></i>Invalid longitude. Please select a valid location.</div>';
                    return;
                }

                // Create date string in YYYY-MM-DD format
                const dateString = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;

                // Show loading state
                const loadingSpinner = document.getElementById('loading-spinner');
                loadingSpinner.style.display = 'block';
                resultsContainer.innerHTML = '';

                try {
                    let apiEndpoint = '/api/get-chaughadiya';
                    let params = `date=${dateString}&latitude=${latitude}&longitude=${longitude}`;

                    const response = await fetch(`${apiEndpoint}?${params}`);
                    
                    // Check if response is ok
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Server error occurred');
                    }
                    
                    const data = await response.json();
                    
                    // Check if data has error property
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    // Fetch Tithi data
                    let tithiData = null;
                    try {
                        const tithiEndpoint = '/api/get-tithi';
                        const tithiParams = `date=${dateString}&latitude=${latitude}&longitude=${longitude}&timezone=${timezone}`;
                        const tithiResponse = await fetch(`${tithiEndpoint}?${tithiParams}`);
                        
                        if (tithiResponse.ok) {
                            tithiData = await tithiResponse.json();
                            if (tithiData.error) {
                                console.warn('Tithi calculation error:', tithiData.error);
                                tithiData = null;
                            }
                        }
                    } catch (tithiError) {
                        console.warn('Failed to fetch Tithi data:', tithiError);
                        // Continue without Tithi data - it's optional
                    }
                    
                    // Convert GMT times to user timezone
                    let convertedData = convertChaughadiyaTimesToUserTimezone(data, timezone);
                    
                    // Apply truncation filters to ensure muhurats fit within 00:00:00 to 24:00:00
                    convertedData = truncateMuhuratsToMidnight(convertedData);
                    
                    // Add Tithi data to converted data
                    if (tithiData) {
                        convertedData.tithi = tithiData;
                    }
                    
                    // Hide loading state
                    loadingSpinner.style.display = 'none';
                    
                    // Store data globally for time format switching
                    window.currentData = convertedData;
                    window.currentTimezone = timezone;
                    lastApiResponse = convertedData; // Store for sharing
                    
                    displayResults(convertedData, timezone);
                } catch (error) {
                    console.error('API Error:', error);
                    loadingSpinner.style.display = 'none';
                    resultsContainer.innerHTML = `<div class="alert alert-danger animate-fade-in">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Error:</strong> ${error.message || 'An error occurred while fetching the data. Please try again.'}
                    </div>`;
                }
            });

            function convertGMTTimeToUserTimezone(timeString, dateString, userTimezone) {
                // Parse the GMT time (HH:MM:SS format)
                const [hours, minutes, seconds] = timeString.split(':').map(Number);
                
                // Create a Date object for the GMT time on the given date
                const gmtDateTime = new Date(`${dateString}T${timeString}Z`);
                
                // Convert to user timezone
                const userDateTime = new Date(gmtDateTime.toLocaleString("en-US", {timeZone: userTimezone}));
                
                // Format as HH:MM:SS
                return userDateTime.toTimeString().slice(0, 8);
            }

            function convertChaughadiyaTimesToUserTimezone(data, userTimezone) {
                if (!data.chaughadiya || !userTimezone) return data;
                
                // Clone the data to avoid modifying the original
                const convertedData = JSON.parse(JSON.stringify(data));
                
                // Convert each muhurat's times
                convertedData.chaughadiya.forEach(muhurat => {
                    muhurat['start-time'] = convertGMTTimeToUserTimezone(
                        muhurat['start-time'], 
                        data.date, 
                        userTimezone
                    );
                    muhurat['end-time'] = convertGMTTimeToUserTimezone(
                        muhurat['end-time'], 
                        data.date, 
                        userTimezone
                    );
                });

                // Convert other time fields if they exist
                if (convertedData['sunrise-time']) {
                    convertedData['sunrise-time'] = convertGMTTimeToUserTimezone(
                        convertedData['sunrise-time'], 
                        data.date, 
                        userTimezone
                    );
                }
                if (convertedData['sunset-time']) {
                    convertedData['sunset-time'] = convertGMTTimeToUserTimezone(
                        convertedData['sunset-time'], 
                        data.date, 
                        userTimezone
                    );
                }
                if (convertedData['prev-sunset-time']) {
                    convertedData['prev-sunset-time'] = convertGMTTimeToUserTimezone(
                        convertedData['prev-sunset-time'], 
                        data.date, 
                        userTimezone
                    );
                }
                if (convertedData['next-sunrise-time']) {
                    convertedData['next-sunrise-time'] = convertGMTTimeToUserTimezone(
                        convertedData['next-sunrise-time'], 
                        data.date, 
                        userTimezone
                    );
                }

                // Convert current muhurat times if they exist
                if (convertedData['current-muhurat-start-time']) {
                    convertedData['current-muhurat-start-time'] = convertGMTTimeToUserTimezone(
                        convertedData['current-muhurat-start-time'], 
                        data.date, 
                        userTimezone
                    );
                }
                if (convertedData['current-muhurat-end-time']) {
                    convertedData['current-muhurat-end-time'] = convertGMTTimeToUserTimezone(
                        convertedData['current-muhurat-end-time'], 
                        data.date, 
                        userTimezone
                    );
                }

                return convertedData;
            }

            function truncateMuhuratsToMidnight(data) {
                if (!data.chaughadiya || !Array.isArray(data.chaughadiya)) return data;
                
                // Clone the data
                const truncatedData = { ...data };
                let muhurats = [...data.chaughadiya];
                
                // Helper function to convert time string "HH:MM:SS" to seconds since midnight
                const timeToSeconds = (timeStr) => {
                    const [h, m, s] = timeStr.split(':').map(Number);
                    return h * 3600 + m * 60 + s;
                };
                
                // Helper function to check if end_time < start_time (wraps to next day)
                const isWrappedToNextDay = (startTime, endTime) => {
                    return timeToSeconds(endTime) <= timeToSeconds(startTime);
                };
                
                // Filter 1: Remove muhurats from the start until we find one where:
                // (end_time < start_time) OR (start_time == 00:00:00)
                let startIndex = 0;
                for (let i = 0; i < muhurats.length; i++) {
                    const muhurat = muhurats[i];
                    const startTime = muhurat['start-time'];
                    const endTime = muhurat['end-time'];
                    
                    if (isWrappedToNextDay(startTime, endTime) || startTime === '00:00:00') {
                        startIndex = i;
                        // Set start time to 00:00:00 for this muhurat
                        muhurats[i] = { ...muhurat, 'start-time': '00:00:00' };
                        break;
                    }
                }
                
                // Remove muhurats before startIndex
                muhurats = muhurats.slice(startIndex);
                
                // Filter 2: Remove muhurats from the end (in reverse) until we find one where:
                // (end_time < start_time) OR (end_time == 00:00:00)
                let endIndex = muhurats.length;
                for (let i = muhurats.length - 1; i >= 0; i--) {
                    const muhurat = muhurats[i];
                    const startTime = muhurat['start-time'];
                    const endTime = muhurat['end-time'];
                    
                    if (isWrappedToNextDay(startTime, endTime) || endTime === '00:00:00') {
                        endIndex = i + 1;
                        // Set end time to 00:00:00 (representing 24:00:00/midnight of next day)
                        muhurats[i] = { ...muhurat, 'end-time': '00:00:00' };
                        break;
                    }
                }
                
                // Keep muhurats up to endIndex
                muhurats = muhurats.slice(0, endIndex);
                
                truncatedData.chaughadiya = muhurats;
                
                // Log for debugging
                console.log('Truncation applied:');
                console.log('  Total muhurats after truncation:', muhurats.length);
                if (muhurats.length > 0) {
                    console.log('  First muhurat:', muhurats[0]);
                    console.log('  Last muhurat:', muhurats[muhurats.length - 1]);
                }
                
                return truncatedData;
            }

            function displayResults(data, userTimezone) {
                if (!data) {
                    resultsContainer.innerHTML = '<div class="alert alert-warning animate-fade-in"><i class="fas fa-exclamation-triangle me-2"></i>No results found.</div>';
                    stopLiveUpdates();
                    return;
                }

                // Regular chaughadiya response
                if (data.chaughadiya) {
                    resultsContainer.innerHTML = generateChaughadiyaTable(data, userTimezone);
                    // Start live updates
                    startLiveUpdates();
                    // Show share button
                    document.getElementById('shareBtn').style.display = 'inline-block';
                } else {
                    resultsContainer.innerHTML = '<div class="alert alert-danger animate-fade-in"><i class="fas fa-exclamation-triangle me-2"></i>An unexpected error occurred.</div>';
                    stopLiveUpdates();
                    document.getElementById('shareBtn').style.display = 'none';
                }
            }

            function convertTo12Hour(timeString) {
                const [hours, minutes] = timeString.split(':').map(Number);
                const period = hours >= 12 ? 'PM' : 'AM';
                const displayHours = hours % 12 || 12;
                return `${String(displayHours).padStart(2, '0')}:${String(minutes).padStart(2, '0')} ${period}`;
            }

            function formatTime(timeString, use24Hour) {
                if (use24Hour) {
                    return timeString;
                }
                return convertTo12Hour(timeString);
            }

            function roundTimeToMinute(timeString) {
                const [hours, minutes, seconds] = timeString.split(':').map(Number);
                const totalSeconds = hours * 3600 + minutes * 60 + seconds;
                const roundedSeconds = Math.round(totalSeconds / 60) * 60;
                const roundedHours = Math.floor(roundedSeconds / 3600);
                const roundedMinutes = Math.floor((roundedSeconds % 3600) / 60);
                return `${String(roundedHours).padStart(2, '0')}:${String(roundedMinutes).padStart(2, '0')}`;
            }

            function formatDuration(durationString) {
                // Parse duration string like "0:52:30" and round to nearest second
                const parts = durationString.split(':');
                if (parts.length === 3) {
                    const hours = parseInt(parts[0]);
                    const minutes = parseInt(parts[1]);
                    const seconds = parseFloat(parts[2]);
                    const roundedSeconds = Math.round(seconds);
                    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(roundedSeconds).padStart(2, '0')}`;
                }
                return durationString;
            }

            function formatISODateTime(isoString, timezone) {
                if (!isoString) return 'N/A';
                try {
                    const date = new Date(isoString);
                    return date.toLocaleString('en-US', { 
                        timeZone: timezone,
                        dateStyle: 'medium',
                        timeStyle: 'short'
                    });
                } catch (e) {
                    return 'N/A';
                }
            }

            function generateTithiHTML(tithiData, timezone) {
                if (!tithiData || tithiData.error) {
                    return '';
                }

                const isPakshaShukla = tithiData.paksha && tithiData.paksha.includes('Shukla');
                const pakshaClass = isPakshaShukla ? 'shukla-paksha' : 'krishna-paksha';
                const moonIcon = isPakshaShukla ? 'fa-moon' : 'fa-moon';
                const moonPhase = isPakshaShukla ? 'Waxing Moon' : 'Waning Moon';
                
                // Get appropriate moon icon based on tithi number
                let moonIconClass = 'fa-moon';
                if (tithiData.tithi_name && tithiData.tithi_name.includes('Purnima')) {
                    moonIconClass = 'fa-circle'; // Full moon
                } else if (tithiData.tithi_name && tithiData.tithi_name.includes('Amavasya')) {
                    moonIconClass = 'fa-circle'; // New moon (will be styled differently)
                }

                // Check if the Tithi data is for today (to show progress bar)
                const isTodayTithi = tithiData.input_date && isDateTodayInTimezone(tithiData.input_date, timezone);

                // Build the HTML
                let html = `
                    <!-- Tithi Information Card -->
                    <div class="card mb-4 tithi-info-card">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-2 text-center mb-3 mb-md-0">
                                    <div class="tithi-icon-container">
                                        <i class="fas ${moonIconClass} fa-4x" style="color: #8a2be2;"></i>
                                    </div>
                                </div>
                                <div class="col-md-${isTodayTithi ? '5' : '6'} mb-3 mb-md-0">
                                    <h4 class="mb-2"><i class="fas fa-calendar-alt me-2" style="color: #8a2be2;"></i>Lunar Day (Tithi)</h4>
                                    <h2 class="mb-2"><strong>${tithiData.tithi_name || 'N/A'}</strong></h2>
                                    <p class="mb-2">
                                        <span class="tithi-paksha-badge ${pakshaClass}">
                                            ${moonPhase} - ${tithiData.paksha || 'N/A'}
                                        </span>
                                    </p>
                                    <p class="mb-1 text-muted"><strong>Significance:</strong> ${tithiData.significance || 'Traditional lunar day'}</p>`;
                
                // Only show progress percentage and progress bar if it's today's Tithi
                if (isTodayTithi) {
                    html += `
                                    <p class="mb-0"><small class="text-muted">Progress: ${tithiData.progress_percentage || 0}% complete</small></p>
                                    <div class="tithi-progress-bar">
                                        <div class="tithi-progress-fill" style="width: ${tithiData.progress_percentage || 0}%"></div>
                                    </div>`;
                }
                
                html += `
                                </div>
                                <div class="col-md-${isTodayTithi ? '5' : '4'}">
                                    <div class="row g-2">
                                        <div class="col-md-6 text-center">
                                            <div class="time-info" style="background: rgba(138, 43, 226, 0.1); border: 2px solid rgba(138, 43, 226, 0.3);">
                                                <h6 class="mb-2"><i class="fas fa-play-circle me-1"></i>Tithi Begins</h6>
                                                <p class="mb-1" style="font-family: 'Courier New', monospace; font-size: 0.9rem;"><strong>${formatISODateTime(tithiData.start_time, timezone)}</strong></p>
                                                <small class="text-muted">Previous: ${tithiData.tithi_number > 1 ? (tithiData.tithi_number === 16 ? 'Purnima' : __getTithiNameByNumber(tithiData.tithi_number - 1)) : 'Amavasya'}</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6 text-center">
                                            <div class="time-info" style="background: rgba(138, 43, 226, 0.1); border: 2px solid rgba(138, 43, 226, 0.3);">
                                                <h6 class="mb-2"><i class="fas fa-stop-circle me-1"></i>Tithi Ends</h6>
                                                <p class="mb-1" style="font-family: 'Courier New', monospace; font-size: 0.9rem;"><strong>${formatISODateTime(tithiData.end_time, timezone)}</strong></p>
                                                <small class="text-muted">Next: ${tithiData.next_tithi_name || 'N/A'}</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                return html;
            }

            // Helper function to get Tithi name by number (for previous Tithi display)
            function __getTithiNameByNumber(number) {
                const tithiNames = [
                    'Pratipada (Shukla)', 'Dwitiya (Shukla)', 'Tritiya (Shukla)', 'Chaturthi (Shukla)',
                    'Panchami (Shukla)', 'Shashthi (Shukla)', 'Saptami (Shukla)', 'Ashtami (Shukla)',
                    'Navami (Shukla)', 'Dashami (Shukla)', 'Ekadashi (Shukla)', 'Dwadashi (Shukla)',
                    'Trayodashi (Shukla)', 'Chaturdashi (Shukla)', 'Purnima',
                    'Pratipada (Krishna)', 'Dwitiya (Krishna)', 'Tritiya (Krishna)', 'Chaturthi (Krishna)',
                    'Panchami (Krishna)', 'Shashthi (Krishna)', 'Saptami (Krishna)', 'Ashtami (Krishna)',
                    'Navami (Krishna)', 'Dashami (Krishna)', 'Ekadashi (Krishna)', 'Dwadashi (Krishna)',
                    'Trayodashi (Krishna)', 'Chaturdashi (Krishna)', 'Amavasya'
                ];
                return tithiNames[number - 1] || 'N/A';
            }

            function isDateTodayInTimezone(dateString, timezone) {
                // Get today's date in the specified timezone
                const now = new Date();
                const todayInTimezone = new Date(now.toLocaleString('en-US', { timeZone: timezone }));
                
                // Format as YYYY-MM-DD
                const year = todayInTimezone.getFullYear();
                const month = String(todayInTimezone.getMonth() + 1).padStart(2, '0');
                const day = String(todayInTimezone.getDate()).padStart(2, '0');
                const todayDateString = `${year}-${month}-${day}`;
                
                return dateString === todayDateString;
            }

            function generateChaughadiyaTable(data, userTimezone) {
                if (!data.chaughadiya || !Array.isArray(data.chaughadiya)) {
                    return '<div class="alert alert-warning animate-fade-in"><i class="fas fa-exclamation-triangle me-2"></i>No chaughadiya data available.</div>';
                }

                // Split chaughadiya into three parts: night (0-7), day (8-15), night (16-23)
                const nightPart1 = data.chaughadiya.slice(0, 8);
                const dayPart = data.chaughadiya.slice(8, 16);
                const nightPart2 = data.chaughadiya.slice(16, 24);

                // Muhurat types and their meanings
                // Using 3 colors: green (good), grey (neutral), red (bad)
                const muhuratInfo = {
                    'Udveg': { color: 'danger', meaning: 'Inauspicious - Avoid important tasks', icon: 'fas fa-times-circle' },
                    'Kaal': { color: 'danger', meaning: 'Very Inauspicious - Not favorable for new ventures', icon: 'fas fa-exclamation-triangle' },
                    'Rog': { color: 'danger', meaning: 'Illness - Health concerns', icon: 'fas fa-user-injured' },
                    'Chal': { color: 'secondary', meaning: 'Movement - Good for travel', icon: 'fas fa-route' },
                    'Labh': { color: 'success', meaning: 'Profit - Good for business', icon: 'fas fa-coins' },
                    'Amrit': { color: 'success', meaning: 'Nectar - Very auspicious', icon: 'fas fa-gem' },
                    'Shubh': { color: 'success', meaning: 'Auspicious - Good for all work', icon: 'fas fa-star' }
                };

                // Helper function to determine if a muhurat is during the day
                const isMuhuratDuringDay = (muhuratStartTime, sunriseTime, sunsetTime) => {
                    const timeToSeconds = (timeStr) => {
                        const [h, m, s] = timeStr.split(':').map(Number);
                        return h * 3600 + m * 60 + s;
                    };
                    
                    const muhuratSeconds = timeToSeconds(muhuratStartTime);
                    const sunriseSeconds = timeToSeconds(sunriseTime);
                    const sunsetSeconds = timeToSeconds(sunsetTime);
                    
                    // Day is from sunrise to sunset
                    // Handle case where sunset might be on next day (shouldn't happen after conversion, but safety check)
                    if (sunsetSeconds < sunriseSeconds) {
                        // Sunset is on next day
                        return muhuratSeconds >= sunriseSeconds || muhuratSeconds < sunsetSeconds;
                    } else {
                        return muhuratSeconds >= sunriseSeconds && muhuratSeconds < sunsetSeconds;
                    }
                };

                const sunriseRounded = roundTimeToMinute(data['sunrise-time']);
                const sunsetRounded = roundTimeToMinute(data['sunset-time']);
                
                // Check if the data date is today in the user's timezone
                const isTodayInTimezone = isDateTodayInTimezone(data.date, userTimezone);
                
                // Get current muhurat only if viewing today's date
                const currentMuhuratData = isTodayInTimezone ? getCurrentMuhurat(data, userTimezone) : null;
                
                let html = `
                    <div class="animate-fade-in">
                `;

                // Add current muhurat banner if data is for today
                if (currentMuhuratData) {
                    const info = muhuratInfo[currentMuhuratData.muhurat.muhurat] || { color: 'secondary', meaning: 'Unknown', icon: 'fas fa-question' };
                    html += `
                        <!-- Current Muhurat Banner -->
                        <div class="current-muhurat-banner" id="current-muhurat-banner">
                            <div class="current-muhurat-content">
                                <div class="row align-items-center">
                                    <div class="col-md-3 text-center mb-3 mb-md-0">
                                        <i class="${info.icon} fa-4x"></i>
                                    </div>
                                    <div class="col-md-6 text-center mb-3 mb-md-0">
                                        <h4 class="mb-2">Current Muhurat</h4>
                                        <h2 class="mb-1"><strong>${currentMuhuratData.muhurat.muhurat}</strong></h2>
                                        <p class="mb-2">${info.meaning}</p>
                                        <div class="live-clock mb-2">
                                            <i class="fas fa-clock me-2"></i><span class="live-clock">Loading...</span>
                                        </div>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <div class="mb-2">Time Remaining</div>
                                        <div class="countdown-timer">Loading...</div>
                                    </div>
                                </div>
                                <div class="progress-bar-muhurat">
                                    <div class="progress-bar-fill" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                html += `
                        <!-- Sunrise and Sunset Times -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-calendar-day me-2"></i>Chaughadiya for ${data.date}</h5>
                                ${userTimezone ? `<small><i class="fas fa-globe me-1"></i>All times shown in ${userTimezone}</small>` : ''}
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-md-6 mb-3">
                                        <div class="time-info sunrise-info">
                                            <div class="sun-icon-container mb-2">
                                                <i class="fas fa-sun fa-3x" style="color: #FFA500;"></i>
                                                <i class="fas fa-arrow-up" style="position: absolute; font-size: 1.2rem; color: #FFD700; margin-left: -0.8rem; margin-top: 0.3rem;"></i>
                                            </div>
                                            <h5 class="mb-2"><i class="fas fa-cloud-sun me-2" style="color: #FFA500;"></i>Sunrise</h5>
                                            <h3 class="mb-0" style="font-family: 'Courier New', monospace;">${formatTime(sunriseRounded, is24HourFormat)}</h3>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="time-info sunset-info">
                                            <div class="moon-icon-container mb-2">
                                                <i class="fas fa-moon fa-3x" style="color: #FF6347;"></i>
                                                <i class="fas fa-arrow-down" style="position: absolute; font-size: 1.2rem; color: #FF4500; margin-left: -0.8rem; margin-top: 0.3rem;"></i>
                                            </div>
                                            <h5 class="mb-2"><i class="fas fa-cloud-moon me-2" style="color: #FF6347;"></i>Sunset</h5>
                                            <h3 class="mb-0" style="font-family: 'Courier New', monospace;">${formatTime(sunsetRounded, is24HourFormat)}</h3>
                                        </div>
                                    </div>
                                </div>

                                <div class="row text-center">
                                    <div class="col-md-6 mb-3">
                                        <div class="time-info">
                                            <h6>Day Muhurat Duration</h6>
                                            <strong style="font-family: 'Courier New', monospace;">${formatDuration(data['day-muhurat-length'])}</strong>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="time-info">
                                            <h6>Night Muhurat Duration</h6>
                                            <strong style="font-family: 'Courier New', monospace;">${formatDuration(data['night-muhurat-length'])}</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                `;

                // Add Tithi information if available
                if (data.tithi) {
                    html += generateTithiHTML(data.tithi, userTimezone);
                }

                html += `
                        <!-- Muhurat Timeline -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-clock me-2"></i>24-Hour Muhurat Timeline</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                `;

                // Create timeline for all 24 muhurats
                const allMuhurats = [...nightPart1, ...dayPart, ...nightPart2];
                allMuhurats.forEach((muhurat, index) => {
                    const info = muhuratInfo[muhurat.muhurat] || { color: 'secondary', meaning: 'Unknown', icon: 'fas fa-question' };
                    const isDay = isMuhuratDuringDay(muhurat['start-time'], data['sunrise-time'], data['sunset-time']);
                    const timelineClass = isDay ? 'border-warning' : 'border-primary';
                    
                    // Check if this is the current muhurat
                    const isCurrent = currentMuhuratData && currentMuhuratData.index === index;
                    const highlightClass = isCurrent ? 'current-muhurat-highlight' : '';
                    
                    const startTimeFormatted = formatTime(muhurat['start-time'], is24HourFormat);
                    const endTimeFormatted = formatTime(muhurat['end-time'], is24HourFormat);
                    
                    html += `
                        <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                            <div class="card h-100 ${timelineClass} ${highlightClass}" style="border-width: 3px;">
                                <div class="card-body text-center p-3 d-flex flex-column">
                                    <div class="mb-2">
                                        <i class="${info.icon} fa-2x text-${info.color}"></i>
                                    </div>
                                    <h6 class="card-title mb-1">
                                        <span class="badge bg-${info.color}">${muhurat.muhurat}</span>
                                    </h6>
                                    <p class="card-text small mb-2" style="font-family: 'Courier New', monospace;">
                                        <strong>${startTimeFormatted} - ${endTimeFormatted}</strong>
                                    </p>
                                    <p class="card-text small text-muted mb-2">${info.meaning}</p>
                                    <div class="mt-auto">
                                        <small class="badge ${isDay ? 'bg-warning text-dark' : 'bg-primary'}">
                                            ${isDay ? 'Day' : 'Night'}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `
                                </div>
                            </div>
                        </div>

                        <!-- Table View -->
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-table me-2"></i>Chaughadiya Table</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table chaughadiya-table mb-0">
                                        <thead>
                                            <tr>
                                                <th style="width: 10%;">#</th>
                                                <th style="width: 20%;">Muhurat</th>
                                                <th style="width: 25%;">Start Time</th>
                                                <th style="width: 25%;">End Time</th>
                                                <th style="width: 20%;">Period</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                `;

                // Generate table rows
                allMuhurats.forEach((muhurat, index) => {
                    const info = muhuratInfo[muhurat.muhurat] || { color: 'secondary', meaning: 'Unknown', icon: 'fas fa-question' };
                    const isDay = isMuhuratDuringDay(muhurat['start-time'], data['sunrise-time'], data['sunset-time']);
                    const isCurrent = currentMuhuratData && currentMuhuratData.index === index;
                    const rowClass = isCurrent ? 'table-warning fw-bold' : '';
                    const startTimeFormatted = formatTime(muhurat['start-time'], is24HourFormat);
                    const endTimeFormatted = formatTime(muhurat['end-time'], is24HourFormat);
                    
                    html += `
                        <tr class="${rowClass}">
                            <td><strong>${index + 1}</strong></td>
                            <td>
                                <i class="${info.icon} text-${info.color} me-2"></i>
                                <strong class="text-${info.color}">${muhurat.muhurat}</strong>
                            </td>
                            <td>${startTimeFormatted}</td>
                            <td>${endTimeFormatted}</td>
                            <td>
                                <span class="badge ${isDay ? 'bg-warning text-dark' : 'bg-primary'}">
                                    ${isDay ? 'Day' : 'Night'}
                                </span>
                            </td>
                        </tr>
                    `;
                });

                html += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                return html;
            }

            // Commented out Google Maps integration
            /*
            function initGoogleMap() {
                // Google Maps API key is required
                const apiKey = 'YOUR_GOOGLE_MAPS_API_KEY';
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap`;
                script.async = true;
                script.defer = true;
                document.head.appendChild(script);
            }

            function initMap() {
                const mapOptions = {
                    center: { lat: 20.5937, lng: 78.9629 },
                    zoom: 5
                };
                const map = new google.maps.Map(document.getElementById('map'), mapOptions);
                let marker = new google.maps.Marker({
                    position: mapOptions.center,
                    map: map
                });

                map.addListener('click', function(e) {
                    marker.setPosition(e.latLng);
                    updateLocationInput(e.latLng.lat(), e.latLng.lng());
                });
            }
            */
        });
    </script>
</body>
</html>
